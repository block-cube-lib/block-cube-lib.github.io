<!DOCTYPE html>
<head>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HH0FEX22FQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-HH0FEX22FQ');
    window['ga-disable-G-HH0FEX22FQ'] = true;
  </script>
  
  <title>
    
      Rustでコンパイル時レイトレーシング3 - blockの巣
    
  </title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="
  
    前回記事
リポジトリ
記事の内容はコミットIDa22c5917e25e505aaeefe75e34121e1817f9ae6cのものです。
今回はようやくレイを飛ばすところまで行け…
  
">

   <!-- begin ogp -->
    <meta property="og:url" content="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;blog&#x2F;compile-time-ray-tracing-in-rust-3&#x2F;">
    <meta property="og:image" content="https://j3mhco9ey2.execute-api.us-east-2.amazonaws.com/default/ogp_image_generator?encoded_url=aHR0cHM6Ly9ibG9jay1jdWJlLWxpYi5naXRodWIuaW8vYmxvZy9jb21waWxlLXRpbWUtcmF5LXRyYWNpbmctaW4tcnVzdC0zLw==">
    <meta property="og:title" content= "Rustでコンパイル時レイトレーシング3" >
    
      <meta name="ogp_thumbnail" content="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;image&#x2F;compile-time-ray-tracing-in-rust&#x2F;image2.png">
    
    
      
          <meta property="og:type" constnt="article">
      
    
    <meta property="og:description" content="前回記事
リポジトリ
記事の内容はコミットIDa22c5917e25e505aaeefe75e34121e1817f9ae6cのものです。
今回はようやくレイを飛ばすところまで行け…">
    <!-- begin twitter ogp -->
    
      <meta name="twitter:card" content="summary_large_image">
      <meta name="twitter:site" content="@block_cube_lib">
      <meta name="twitter:title" content= "Rustでコンパイル時レイトレーシング3" >
    
    <!-- end twitter ogp -->
   <!-- end ogp -->
  <link rel="stylesheet" type="text/css" href="https://block-cube-lib.github.io/style.css">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
</head>

<body>
  <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
  <header class="header">
    
    <div class="container" id="ga_cookie_accept_menu"></div>
    
    <div class="container">
      <a href="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;">blockの巣</a>
      <nav>
        
        <a class="nav_content" href="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;blog&#x2F;">Blog</a>
        
        <a class="nav_content" href="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;tags&#x2F;">Tags</a>
        
        <a class="nav_content" href="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;about&#x2F;">About</a>
        
        <a class="nav_content" href="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;works&#x2F;">Works</a>
        
        <a class="nav_content" href="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;privacy-policy&#x2F;">Privacy Policy</a>
        
      </nav>
    </div>
  </header>
  <section class="section">
    <div class="container">
      
<h1 class="title">
  Rustでコンパイル時レイトレーシング3
</h1>
  <section class="update_history">
    <table>
      <tr>
        <td>
  <span class = "date">2022&#x2F;02&#x2F;04 00:20</span>
</td>
        <td>公開</td>
      </tr>
      
        
        <tr>
          <td>
  <span class = "date">2022&#x2F;02&#x2F;05 12:52</span>
</td>
          <td class="update_history_content"><p>背景色が間違っていたのを修正</p>
</td>
        </tr>
        
        <tr>
          <td>
  <span class = "date">2022&#x2F;02&#x2F;16 01:38</span>
</td>
          <td class="update_history_content"><p>背景のグラデーションの向きの修正とリポジトリへのリンクを修正</p>
</td>
        </tr>
        
      
    </table>
  </section>
<section class="tags">
  
  
  
  <span class = "tag"><a href="https://block-cube-lib.github.io/tags/compile-time-ray-tracing-in-rust/">Compile Time Ray Tracing in Rust</a></span>

  
  
  <span class = "tag"><a href="https://block-cube-lib.github.io/tags/ray-tracing/">Ray Tracing</a></span>

  
  
  <span class = "tag"><a href="https://block-cube-lib.github.io/tags/rust/">Rust</a></span>

  

</section>
<p><p><a href="../compile-time-ray-tracing-in-rust-2">前回記事</a><br />
<a href="https://github.com/block-cube-lib/compile-time-ray-tracing-in-rust">リポジトリ</a><br />
記事の内容はコミットID<a href="https://github.com/block-cube-lib/compile-time-ray-tracing-in-rust/tree/a22c5917e25e505aaeefe75e34121e1817f9ae6c"><code>a22c5917e25e505aaeefe75e34121e1817f9ae6c</code></a>のものです。</p>
<p>今回はようやくレイを飛ばすところまで行けました！<br />
といってもオブジェクトにヒットするとかはしておらずレイの向きによって色が変わっているだけなのでまだレイトレーシングっぽくないですね。</p>
<p>レンダリング結果<br />
<img src="/image/compile-time-ray-tracing-in-rust/image2.png" alt="レンダリング結果" /></p>
<h2 id="jin-hui-nobian-geng-dian">今回の変更点</h2>
<ul>
<li><code>Ray</code>型を追加(<code>ray.rs</code>)</li>
<li>新しい<code>feature</code>(<code>const_eval_limit</code>)を追加</li>
<li><code>main.rs</code>で<code>Ray</code>を使用する</li>
</ul>
<h3 id="ray-rs">ray.rs</h3>
<p>まず<code>Ray</code>型の内容からです。
レイの始点と方向を持つだけの<code>struct</code>です。特別注意が必要なことはないと思います。</p>
<pre data-lang="rust" style="background-color:#000000;color:#dedede;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#c397d8;">use crate</span><span>::{Point3, Vec3};
</span><span>
</span><span>#[</span><span style="color:#d54e53;">derive</span><span>(Clone, Copy, Debug)]
</span><span style="color:#c397d8;">pub struct </span><span>Ray {
</span><span>    </span><span style="color:#c397d8;">pub </span><span style="color:#d54e53;">orig</span><span>: Point3,
</span><span>    </span><span style="color:#c397d8;">pub </span><span style="color:#d54e53;">dir</span><span>: Vec3,
</span><span>}
</span><span>
</span><span style="color:#c397d8;">impl </span><span>Ray {
</span><span>    </span><span style="color:#c397d8;">pub const fn </span><span style="color:#7aa6da;">new</span><span>(</span><span style="color:#e78c45;">origin</span><span>: </span><span style="color:#70c0b1;">&amp;</span><span>Point3, </span><span style="color:#e78c45;">direction</span><span>: </span><span style="color:#70c0b1;">&amp;</span><span>Vec3) -&gt; </span><span style="color:#c397d8;">Self </span><span>{
</span><span>        Ray {
</span><span>            orig: origin.</span><span style="color:#7aa6da;">clone</span><span>(),
</span><span>            dir: direction.</span><span style="color:#7aa6da;">clone</span><span>(),
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#c397d8;">pub const fn </span><span style="color:#7aa6da;">origin</span><span>(</span><span style="color:#70c0b1;">&amp;</span><span style="color:#e78c45;">self</span><span>) -&gt; Point3 {
</span><span>        </span><span style="color:#d54e53;">self</span><span>.orig
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#c397d8;">pub const fn </span><span style="color:#7aa6da;">direction</span><span>(</span><span style="color:#70c0b1;">&amp;</span><span style="color:#e78c45;">self</span><span>) -&gt; Vec3 {
</span><span>        </span><span style="color:#d54e53;">self</span><span>.dir
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#c397d8;">pub const fn </span><span style="color:#7aa6da;">at</span><span>(</span><span style="color:#70c0b1;">&amp;</span><span style="color:#e78c45;">self</span><span>, </span><span style="color:#e78c45;">t</span><span>: </span><span style="color:#c397d8;">f64</span><span>) -&gt; Vec3 {
</span><span>        </span><span style="color:#d54e53;">self</span><span>.orig </span><span style="color:#70c0b1;">+ </span><span style="color:#d54e53;">self</span><span>.dir </span><span style="color:#70c0b1;">*</span><span> t
</span><span>    }
</span><span>}
</span></code></pre>
<h3 id="lib-rs">lib.rs</h3>
<p><code>lib.rs</code>の内容は<code>ray</code> moduleの宣言などの他<code>const_eval_limit</code>という<code>feature</code>の宣言が増えています。</p>
<pre data-lang="rust" style="background-color:#000000;color:#dedede;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#![</span><span style="color:#d54e53;">feature</span><span>(const_trait_impl)]
</span><span>#![</span><span style="color:#d54e53;">feature</span><span>(const_fn_floating_point_arithmetic)]
</span><span>#![</span><span style="color:#d54e53;">feature</span><span>(const_mut_refs)]
</span><span>#![</span><span style="color:#d54e53;">feature</span><span>(const_eval_limit)]
</span><span>#![</span><span style="color:#d54e53;">const_eval_limit </span><span style="color:#70c0b1;">= </span><span style="color:#b9ca4a;">&quot;0&quot;</span><span>]
</span><span style="color:#c397d8;">pub mod </span><span>ray;
</span><span style="color:#c397d8;">pub mod </span><span>util;
</span><span style="color:#c397d8;">pub mod </span><span>vec3;
</span><span>
</span><span style="color:#c397d8;">pub use </span><span>ray::</span><span style="color:#70c0b1;">*</span><span>;
</span><span style="color:#c397d8;">pub use </span><span>vec3::</span><span style="color:#70c0b1;">*</span><span>;
</span><span>
</span><span style="color:#c397d8;">pub type </span><span>Point3 </span><span style="color:#70c0b1;">=</span><span> Vec3;
</span><span style="color:#c397d8;">pub type </span><span>Color </span><span style="color:#70c0b1;">=</span><span> Vec3;
</span></code></pre>
<h4 id="const-eval-limit">const_eval_limit</h4>
<p><code>const_eval_limit</code>とは<code>const fn</code>の中でのステップ数の制限をコントロールするための<code>feature</code>です。</p>
<pre data-lang="rust" style="background-color:#000000;color:#dedede;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#![</span><span style="color:#d54e53;">feature</span><span>(const_eval_limit)]
</span><span>#![</span><span style="color:#d54e53;">const_eval_limit </span><span style="color:#70c0b1;">= </span><span style="color:#b9ca4a;">&quot;N&quot;</span><span>]
</span></code></pre>
<p>とすることでステップ数の制限を<code>N</code>に設定できます。N = 0のときは無制限になります。<br />
これを使用しないと<code>const fn</code>で<code>sqrt</code>を呼び出しただけでステップ数の上限に引っかかってしまいまともにコードを書けそうになかったので追加しました。</p>
<h3 id="main-rs">main.rs</h3>
<p><code>main.rs</code>の内容を先に貼っておきます。
変更点がない箇所は省略しています。</p>
<details><summary>main.rs</summary>
<pre data-lang="rust" style="background-color:#000000;color:#dedede;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#![</span><span style="color:#d54e53;">feature</span><span>(const_trait_impl)]
</span><span>#![</span><span style="color:#d54e53;">feature</span><span>(const_fn_floating_point_arithmetic)]
</span><span>#![</span><span style="color:#d54e53;">feature</span><span>(const_mut_refs)]
</span><span>#![</span><span style="color:#d54e53;">feature</span><span>(const_eval_limit)]
</span><span>#![</span><span style="color:#d54e53;">const_eval_limit </span><span style="color:#70c0b1;">= </span><span style="color:#b9ca4a;">&quot;0&quot;</span><span>]
</span><span>
</span><span style="color:#c397d8;">use </span><span>image::ImageFormat;
</span><span style="color:#c397d8;">use </span><span>ray_tracing_in_one_weekend_compile_time::</span><span style="color:#70c0b1;">*</span><span>;
</span><span>
</span><span style="color:#c397d8;">const </span><span style="color:#eeeeee;">ASPECT_RATIO</span><span>: </span><span style="color:#c397d8;">f64 </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">16.0 </span><span style="color:#70c0b1;">/ </span><span style="color:#e78c45;">9.0</span><span>;
</span><span style="color:#c397d8;">const </span><span style="color:#eeeeee;">IMAGE_WIDTH</span><span>: </span><span style="color:#c397d8;">usize </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">400</span><span>;
</span><span style="color:#c397d8;">const </span><span style="color:#eeeeee;">IMAGE_HEIGHT</span><span>: </span><span style="color:#c397d8;">usize </span><span style="color:#70c0b1;">= </span><span>(</span><span style="color:#eeeeee;">IMAGE_WIDTH </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">f64 </span><span style="color:#70c0b1;">/ </span><span style="color:#eeeeee;">ASPECT_RATIO</span><span>) </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">usize</span><span>;
</span><span style="color:#c397d8;">const </span><span style="color:#eeeeee;">PIXEL_COUNT</span><span>: </span><span style="color:#c397d8;">usize </span><span style="color:#70c0b1;">= </span><span style="color:#eeeeee;">IMAGE_WIDTH </span><span style="color:#70c0b1;">* </span><span style="color:#eeeeee;">IMAGE_HEIGHT</span><span>;
</span><span>
</span><span style="color:#c397d8;">const fn </span><span style="color:#7aa6da;">ray_color</span><span>(</span><span style="color:#e78c45;">ray</span><span>: </span><span style="color:#70c0b1;">&amp;</span><span>Ray) -&gt; Color {
</span><span>    </span><span style="color:#c397d8;">let</span><span> unit_direction </span><span style="color:#70c0b1;">= </span><span style="color:#7aa6da;">unit_vector</span><span>(</span><span style="color:#70c0b1;">&amp;</span><span>ray.</span><span style="color:#7aa6da;">direction</span><span>());
</span><span>    </span><span style="color:#c397d8;">let</span><span> t </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">0.5 </span><span style="color:#70c0b1;">*</span><span> unit_direction.y </span><span style="color:#70c0b1;">+ </span><span style="color:#e78c45;">1.0</span><span>;
</span><span>    (</span><span style="color:#e78c45;">1.0 </span><span style="color:#70c0b1;">-</span><span> t) </span><span style="color:#70c0b1;">* </span><span>Color::new(</span><span style="color:#e78c45;">1.0</span><span>, </span><span style="color:#e78c45;">1.0</span><span>, </span><span style="color:#e78c45;">1.0</span><span>) </span><span style="color:#70c0b1;">+</span><span> t </span><span style="color:#70c0b1;">* </span><span>Color::new(</span><span style="color:#e78c45;">0.5</span><span>, </span><span style="color:#e78c45;">0.7</span><span>, </span><span style="color:#e78c45;">1.0</span><span>)
</span><span>}
</span><span>
</span><span style="color:#c397d8;">fn </span><span style="color:#7aa6da;">main</span><span>() -&gt; anyhow::</span><span style="color:#e7c547;">Result</span><span>&lt;()&gt; {
</span><span>    </span><span style="color:#999999;">// 省略
</span><span>}
</span><span>
</span><span style="color:#c397d8;">const fn </span><span style="color:#7aa6da;">ray_trace</span><span>() -&gt; [Color; </span><span style="color:#eeeeee;">PIXEL_COUNT</span><span>] {
</span><span>    </span><span style="color:#c397d8;">let</span><span> viewport_height </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">2.0</span><span>;
</span><span>    </span><span style="color:#c397d8;">let</span><span> viewport_width </span><span style="color:#70c0b1;">=</span><span> viewport_height </span><span style="color:#70c0b1;">* </span><span style="color:#eeeeee;">ASPECT_RATIO</span><span>;
</span><span>    </span><span style="color:#c397d8;">let</span><span> focal_length </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">1.0</span><span>;
</span><span>
</span><span>    </span><span style="color:#c397d8;">let</span><span> origin </span><span style="color:#70c0b1;">= </span><span>Point3::</span><span style="color:#eeeeee;">ZERO</span><span>;
</span><span>    </span><span style="color:#c397d8;">let</span><span> horizontal </span><span style="color:#70c0b1;">= </span><span>Vec3::new(viewport_width, </span><span style="color:#e78c45;">0.0</span><span>, </span><span style="color:#e78c45;">0.0</span><span>);
</span><span>    </span><span style="color:#c397d8;">let</span><span> vertical </span><span style="color:#70c0b1;">= </span><span>Vec3::new(</span><span style="color:#e78c45;">0.0</span><span>, viewport_height, </span><span style="color:#e78c45;">0.0</span><span>);
</span><span>    </span><span style="color:#c397d8;">let</span><span> lower_left_corner </span><span style="color:#70c0b1;">=
</span><span>        origin </span><span style="color:#70c0b1;">-</span><span> horizontal </span><span style="color:#70c0b1;">/ </span><span style="color:#e78c45;">2.0 </span><span style="color:#70c0b1;">-</span><span> vertical </span><span style="color:#70c0b1;">/ </span><span style="color:#e78c45;">2.0 </span><span style="color:#70c0b1;">- </span><span>Vec3::new(</span><span style="color:#e78c45;">0.0</span><span>, </span><span style="color:#e78c45;">0.0</span><span>, focal_length);
</span><span>
</span><span>    </span><span style="color:#c397d8;">let mut</span><span> pixel_colors </span><span style="color:#70c0b1;">= </span><span>[Color::</span><span style="color:#eeeeee;">ZERO</span><span>; </span><span style="color:#eeeeee;">PIXEL_COUNT</span><span>];
</span><span>    </span><span style="color:#c397d8;">let mut</span><span> i </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">0</span><span>;
</span><span>    </span><span style="color:#c397d8;">let mut</span><span> j </span><span style="color:#70c0b1;">= </span><span>(</span><span style="color:#eeeeee;">IMAGE_HEIGHT </span><span style="color:#70c0b1;">- </span><span style="color:#e78c45;">1</span><span>) </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">i32</span><span>;
</span><span>    </span><span style="color:#c397d8;">let mut</span><span> pixel_index </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">0</span><span>;
</span><span>    </span><span style="color:#999999;">// forが使えないのでwhileで代用
</span><span>    </span><span style="color:#c397d8;">while </span><span style="color:#e78c45;">0 </span><span style="color:#70c0b1;">&lt;=</span><span> j {
</span><span>        </span><span style="color:#c397d8;">while</span><span> i </span><span style="color:#70c0b1;">&lt; </span><span style="color:#eeeeee;">IMAGE_WIDTH </span><span>{
</span><span>            </span><span style="color:#c397d8;">let</span><span> u </span><span style="color:#70c0b1;">= </span><span>(i </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">f64</span><span>) </span><span style="color:#70c0b1;">/ </span><span>(</span><span style="color:#eeeeee;">IMAGE_WIDTH </span><span style="color:#70c0b1;">- </span><span style="color:#e78c45;">1</span><span>) </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">f64</span><span>;
</span><span>            </span><span style="color:#c397d8;">let</span><span> v </span><span style="color:#70c0b1;">= </span><span>(j </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">f64</span><span>) </span><span style="color:#70c0b1;">/ </span><span>(</span><span style="color:#eeeeee;">IMAGE_HEIGHT </span><span style="color:#70c0b1;">- </span><span style="color:#e78c45;">1</span><span>) </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">f64</span><span>;
</span><span>            </span><span style="color:#c397d8;">let</span><span> r </span><span style="color:#70c0b1;">= </span><span>Ray::new(
</span><span>                </span><span style="color:#70c0b1;">&amp;</span><span>origin,
</span><span>                </span><span style="color:#70c0b1;">&amp;</span><span>(lower_left_corner </span><span style="color:#70c0b1;">+</span><span> u </span><span style="color:#70c0b1;">*</span><span> horizontal </span><span style="color:#70c0b1;">+</span><span> v </span><span style="color:#70c0b1;">*</span><span> vertical </span><span style="color:#70c0b1;">-</span><span> origin),
</span><span>            );
</span><span>            pixel_colors[pixel_index] </span><span style="color:#70c0b1;">= </span><span style="color:#7aa6da;">ray_color</span><span>(</span><span style="color:#70c0b1;">&amp;</span><span>r);
</span><span>            i </span><span style="color:#70c0b1;">+= </span><span style="color:#e78c45;">1</span><span>;
</span><span>            pixel_index </span><span style="color:#70c0b1;">+= </span><span style="color:#e78c45;">1</span><span>;
</span><span>        }
</span><span>        i </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">0</span><span>;
</span><span>        j </span><span style="color:#70c0b1;">-= </span><span style="color:#e78c45;">1</span><span>;
</span><span>    }
</span><span>    pixel_colors
</span><span>}
</span><span>
</span><span style="color:#999999;">// 省略
</span></code></pre>
</details>
<p>まず<code>main.rs</code>でも<code>const_eval_limit</code>が追加されています。
ループの中でステップ数の上限に引っかかるので上限なしにしてあります。</p>
<pre data-lang="rust" style="background-color:#000000;color:#dedede;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#![</span><span style="color:#d54e53;">feature</span><span>(const_eval_limit)]
</span><span>#![</span><span style="color:#d54e53;">const_eval_limit </span><span style="color:#70c0b1;">= </span><span style="color:#b9ca4a;">&quot;0&quot;</span><span>]
</span></code></pre>
<p>画像は横400を基準としてアスペクト比16:9になるように設定しています。</p>
<pre data-lang="rust" style="background-color:#000000;color:#dedede;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#c397d8;">const </span><span style="color:#eeeeee;">ASPECT_RATIO</span><span>: </span><span style="color:#c397d8;">f64 </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">16.0 </span><span style="color:#70c0b1;">/ </span><span style="color:#e78c45;">9.0</span><span>;
</span><span style="color:#c397d8;">const </span><span style="color:#eeeeee;">IMAGE_WIDTH</span><span>: </span><span style="color:#c397d8;">usize </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">400</span><span>;
</span><span style="color:#c397d8;">const </span><span style="color:#eeeeee;">IMAGE_HEIGHT</span><span>: </span><span style="color:#c397d8;">usize </span><span style="color:#70c0b1;">= </span><span>(</span><span style="color:#eeeeee;">IMAGE_WIDTH </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">f64 </span><span style="color:#70c0b1;">/ </span><span style="color:#eeeeee;">ASPECT_RATIO</span><span>) </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">usize</span><span>;
</span></code></pre>
<p><code>ray_color</code>関数は引数の<code>Ray</code>を飛ばしてヒットした箇所の色を返す関数です。<br />
現時点ではヒットするオブジェクトがないのでレイの向きを元に返す色を決めています。</p>
<pre data-lang="rust" style="background-color:#000000;color:#dedede;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#c397d8;">const fn </span><span style="color:#7aa6da;">ray_color</span><span>(</span><span style="color:#e78c45;">ray</span><span>: </span><span style="color:#70c0b1;">&amp;</span><span>Ray) -&gt; Color {
</span><span>    </span><span style="color:#c397d8;">let</span><span> unit_direction </span><span style="color:#70c0b1;">= </span><span style="color:#7aa6da;">unit_vector</span><span>(</span><span style="color:#70c0b1;">&amp;</span><span>ray.</span><span style="color:#7aa6da;">direction</span><span>());
</span><span>    </span><span style="color:#c397d8;">let</span><span> t </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">0.5 </span><span style="color:#70c0b1;">*</span><span> unit_direction.y </span><span style="color:#70c0b1;">+ </span><span style="color:#e78c45;">1.0</span><span>;
</span><span>    (</span><span style="color:#e78c45;">1.0 </span><span style="color:#70c0b1;">-</span><span> t) </span><span style="color:#70c0b1;">* </span><span>Color::new(</span><span style="color:#e78c45;">1.0</span><span>, </span><span style="color:#e78c45;">1.0</span><span>, </span><span style="color:#e78c45;">1.0</span><span>) </span><span style="color:#70c0b1;">+</span><span> t </span><span style="color:#70c0b1;">* </span><span>Color::new(</span><span style="color:#e78c45;">0.5</span><span>, </span><span style="color:#e78c45;">0.7</span><span>, </span><span style="color:#e78c45;">1.0</span><span>)
</span><span>}
</span></code></pre>
<p><code>ray_trace</code>関数ではピクセルごとにレイを生成して<code>ray_color</code>関数の返り値を配列に格納しています。</p>
<pre data-lang="rust" style="background-color:#000000;color:#dedede;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#c397d8;">const fn </span><span style="color:#7aa6da;">ray_trace</span><span>() -&gt; [Color; </span><span style="color:#eeeeee;">PIXEL_COUNT</span><span>] {
</span><span>    </span><span style="color:#c397d8;">let</span><span> viewport_height </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">2.0</span><span>;
</span><span>    </span><span style="color:#c397d8;">let</span><span> viewport_width </span><span style="color:#70c0b1;">=</span><span> viewport_height </span><span style="color:#70c0b1;">* </span><span style="color:#eeeeee;">ASPECT_RATIO</span><span>;
</span><span>    </span><span style="color:#c397d8;">let</span><span> focal_length </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">1.0</span><span>;
</span><span>
</span><span>    </span><span style="color:#c397d8;">let</span><span> origin </span><span style="color:#70c0b1;">= </span><span>Point3::</span><span style="color:#eeeeee;">ZERO</span><span>;
</span><span>    </span><span style="color:#c397d8;">let</span><span> horizontal </span><span style="color:#70c0b1;">= </span><span>Vec3::new(viewport_width, </span><span style="color:#e78c45;">0.0</span><span>, </span><span style="color:#e78c45;">0.0</span><span>);
</span><span>    </span><span style="color:#c397d8;">let</span><span> vertical </span><span style="color:#70c0b1;">= </span><span>Vec3::new(</span><span style="color:#e78c45;">0.0</span><span>, viewport_height, </span><span style="color:#e78c45;">0.0</span><span>);
</span><span>    </span><span style="color:#c397d8;">let</span><span> lower_left_corner </span><span style="color:#70c0b1;">=
</span><span>        origin </span><span style="color:#70c0b1;">-</span><span> horizontal </span><span style="color:#70c0b1;">/ </span><span style="color:#e78c45;">2.0 </span><span style="color:#70c0b1;">-</span><span> vertical </span><span style="color:#70c0b1;">/ </span><span style="color:#e78c45;">2.0 </span><span style="color:#70c0b1;">- </span><span>Vec3::new(</span><span style="color:#e78c45;">0.0</span><span>, </span><span style="color:#e78c45;">0.0</span><span>, focal_length);
</span><span>
</span><span>    </span><span style="color:#c397d8;">let mut</span><span> pixel_colors </span><span style="color:#70c0b1;">= </span><span>[Color::</span><span style="color:#eeeeee;">ZERO</span><span>; </span><span style="color:#eeeeee;">PIXEL_COUNT</span><span>];
</span><span>    </span><span style="color:#c397d8;">let mut</span><span> i </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">0</span><span>;
</span><span>    </span><span style="color:#c397d8;">let mut</span><span> j </span><span style="color:#70c0b1;">= </span><span>(</span><span style="color:#eeeeee;">IMAGE_HEIGHT </span><span style="color:#70c0b1;">- </span><span style="color:#e78c45;">1</span><span>) </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">i32</span><span>;
</span><span>    </span><span style="color:#c397d8;">let mut</span><span> pixel_index </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">0</span><span>;
</span><span>    </span><span style="color:#999999;">// forが使えないのでwhileで代用
</span><span>    </span><span style="color:#c397d8;">while </span><span style="color:#e78c45;">0 </span><span style="color:#70c0b1;">&lt;=</span><span> j {
</span><span>        </span><span style="color:#c397d8;">while</span><span> i </span><span style="color:#70c0b1;">&lt; </span><span style="color:#eeeeee;">IMAGE_WIDTH </span><span>{
</span><span>            </span><span style="color:#c397d8;">let</span><span> u </span><span style="color:#70c0b1;">= </span><span>(i </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">f64</span><span>) </span><span style="color:#70c0b1;">/ </span><span>(</span><span style="color:#eeeeee;">IMAGE_WIDTH </span><span style="color:#70c0b1;">- </span><span style="color:#e78c45;">1</span><span>) </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">f64</span><span>;
</span><span>            </span><span style="color:#c397d8;">let</span><span> v </span><span style="color:#70c0b1;">= </span><span>(j </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">f64</span><span>) </span><span style="color:#70c0b1;">/ </span><span>(</span><span style="color:#eeeeee;">IMAGE_HEIGHT </span><span style="color:#70c0b1;">- </span><span style="color:#e78c45;">1</span><span>) </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">f64</span><span>;
</span><span>            </span><span style="color:#c397d8;">let</span><span> r </span><span style="color:#70c0b1;">= </span><span>Ray::new(
</span><span>                </span><span style="color:#70c0b1;">&amp;</span><span>origin,
</span><span>                </span><span style="color:#70c0b1;">&amp;</span><span>(lower_left_corner </span><span style="color:#70c0b1;">+</span><span> u </span><span style="color:#70c0b1;">*</span><span> horizontal </span><span style="color:#70c0b1;">+</span><span> v </span><span style="color:#70c0b1;">*</span><span> vertical </span><span style="color:#70c0b1;">-</span><span> origin),
</span><span>            );
</span><span>            pixel_colors[pixel_index] </span><span style="color:#70c0b1;">= </span><span style="color:#7aa6da;">ray_color</span><span>(</span><span style="color:#70c0b1;">&amp;</span><span>r);
</span><span>            i </span><span style="color:#70c0b1;">+= </span><span style="color:#e78c45;">1</span><span>;
</span><span>            pixel_index </span><span style="color:#70c0b1;">+= </span><span style="color:#e78c45;">1</span><span>;
</span><span>        }
</span><span>        i </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">0</span><span>;
</span><span>        j </span><span style="color:#70c0b1;">-= </span><span style="color:#e78c45;">1</span><span>;
</span><span>    }
</span><span>    pixel_colors
</span><span>}
</span></code></pre>
<h2 id="matome">まとめ</h2>
<p>今回でようやく<code>Ray</code>が登場しました。<br />
かんたんに書くためにまた新しい<code>const_eval_limit</code>という<code>feature</code>を使用しました。
どんどんnightlyでしか書けないコードになってきましたね。stableの制限の中でもやりたいと思ったことはあるのですがだいぶ難しそうです。<br />
次は球とレイの交差判定を行います。</p>
</p>
<hr>
<p class="share_buttons">
  <a class="twitter-share-button" data-text="Rustでコンパイル時レイトレーシング3 - blockの巣" href="https://twitter.com/intent/tweet">Tweet</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</p>

    </div>
  </section>
  <footer>
    
    
    copyright 2019 block.
    
    
  </footer>

  
  <script>
    const ga_tracking_id = "G-HH0FEX22FQ";
    const ga_accept_message = `<ul>
<li>当サイトではアクセス解析ツールGoogle Analyticsを使用しています</li>
<li>Google Analyticsはトラフィックデータの収集のためにCookieを使用します</li>
<li>データ収集の同意の状態はPrivacy Policyからいつでもリセットできます</li>
<li>サイトの閲覧数などを確認したいので同意していただけると嬉しいです</li>
</ul>
`;
    const privacy_policy_url = "https://block-cube-lib.github.io/privacy-policy/";
  </script>
  <script src="https://block-cube-lib.github.io/js/ga-cookie-accept.js"></script>
  
</body>

</html>
