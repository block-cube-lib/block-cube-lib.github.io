<!DOCTYPE html>
<head>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HH0FEX22FQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-HH0FEX22FQ');
    window['ga-disable-G-HH0FEX22FQ'] = true;
  </script>
  
  <title>
    
      Rustでコンパイル時レイトレーシング2 - blockの巣
    
  </title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="
  
    前回記事
リポジトリ
記事の内容はコミットID82481b974f2684a73a4940a85f92de74f9f05b7eのものです。
今回はVec3の定義とピクセルのバッファ…
  
">

   <!-- begin ogp -->
    <meta property="og:url" content="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;blog&#x2F;compile-time-ray-tracing-in-rust-2&#x2F;">
    <meta property="og:image" content="https://j3mhco9ey2.execute-api.us-east-2.amazonaws.com/default/ogp_image_generator?encoded_url=aHR0cHM6Ly9ibG9jay1jdWJlLWxpYi5naXRodWIuaW8vYmxvZy9jb21waWxlLXRpbWUtcmF5LXRyYWNpbmctaW4tcnVzdC0yLw==">
    <meta property="og:title" content= "Rustでコンパイル時レイトレーシング2" >
    
    
      
          <meta property="og:type" constnt="article">
      
    
    <meta property="og:description" content="前回記事
リポジトリ
記事の内容はコミットID82481b974f2684a73a4940a85f92de74f9f05b7eのものです。
今回はVec3の定義とピクセルのバッファ…">
    <!-- begin twitter ogp -->
    
      <meta name="twitter:card" content="summary_large_image">
      <meta name="twitter:site" content="@block_cube_lib">
      <meta name="twitter:title" content= "Rustでコンパイル時レイトレーシング2" >
    
    <!-- end twitter ogp -->
   <!-- end ogp -->
  <link rel="stylesheet" type="text/css" href="https://block-cube-lib.github.io/style.css">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
</head>

<body>
  <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
  <header class="header">
    
    <div class="container" id="ga_cookie_accept_menu"></div>
    
    <div class="container">
      <a href="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;">blockの巣</a>
      <nav>
        
        <a class="nav_content" href="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;blog&#x2F;">Blog</a>
        
        <a class="nav_content" href="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;tags&#x2F;">Tags</a>
        
        <a class="nav_content" href="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;about&#x2F;">About</a>
        
        <a class="nav_content" href="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;works&#x2F;">Works</a>
        
        <a class="nav_content" href="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;privacy-policy&#x2F;">Privacy Policy</a>
        
      </nav>
    </div>
  </header>
  <section class="section">
    <div class="container">
      
<h1 class="title">
  Rustでコンパイル時レイトレーシング2
</h1>
  <section class="update_history">
    <table>
      <tr>
        <td>
  <span class = "date">2022&#x2F;01&#x2F;31 12:35</span>
</td>
        <td>公開</td>
      </tr>
      
        
        <tr>
          <td>
  <span class = "date">2022&#x2F;01&#x2F;21 20:48</span>
</td>
          <td class="update_history_content"><p><code>Vec3</code>に<code>Add</code>と<code>Sub</code>が実装されていなかったのを修正</p>
</td>
        </tr>
        
        <tr>
          <td>
  <span class = "date">2022&#x2F;01&#x2F;21 21:43</span>
</td>
          <td class="update_history_content"><p>リポジトリへのリンクを追加</p>
</td>
        </tr>
        
        <tr>
          <td>
  <span class = "date">2022&#x2F;02&#x2F;16 01:26</span>
</td>
          <td class="update_history_content"><p>リポジトリへのリンクを修正</p>
</td>
        </tr>
        
      
    </table>
  </section>
<section class="tags">
  
  
  
  <span class = "tag"><a href="https://block-cube-lib.github.io/tags/compile-time-ray-tracing-in-rust/">Compile Time Ray Tracing in Rust</a></span>

  
  
  <span class = "tag"><a href="https://block-cube-lib.github.io/tags/ray-tracing/">Ray Tracing</a></span>

  
  
  <span class = "tag"><a href="https://block-cube-lib.github.io/tags/rust/">Rust</a></span>

  

</section>
<p><p><a href="../compile-time-ray-tracing-in-rust-1">前回記事</a><br />
<a href="https://github.com/block-cube-lib/compile-time-ray-tracing-in-rust">リポジトリ</a><br />
記事の内容はコミットID<a href="https://github.com/block-cube-lib/compile-time-ray-tracing-in-rust/tree/9a868c28267de078d29e4b129c8a043b0ed76501"><code>82481b974f2684a73a4940a85f92de74f9f05b7e</code></a>のものです。</p>
<p>今回は<code>Vec3</code>の定義とピクセルのバッファの型にタプルを使っていた部分を<code>Color</code>(<code>Vec3</code>)に置き換えるところまで行います。
なのでまだレイトレーシングらしい処理は出てこず、レンダリング結果も前回と変わりません。</p>
<p>今回追加したファイルは<code>lib.rs</code>, <code>util.rs</code>, <code>vec3.rs</code>です。<br />
<code>lib.rs</code>は各モジュールの宣言、useを行っており、<code>util.rs</code>は<code>Vec3</code>で使用する関数を定義しています。<br />
<code>vec3.rs</code>は<code>Vec3</code>型とそれに関連する関数の定義を行っています。</p>
<h2 id="lib-rs">lib.rs</h2>
<p>まずは<code>lib.rs</code>の内容からです。</p>
<p>必要なfeatureを有効化、各モジュールの宣言、use宣言、<code>Vec3</code>のエイリアスとして<code>Point3</code>と<code>Color</code>の定義を行っています。<br />
有効化したfeatureは<a href="https://qiita.com/block/items/d72a7e173ee0f1b196e6">Traitの関数をconst fnとして実装できるようになる(かもしれない)話</a>と<a href="../const-vec3">const fnで使用可能なVec3を定義する</a>で解説しています。</p>
<pre data-lang="rs" style="background-color:#000000;color:#dedede;" class="language-rs "><code class="language-rs" data-lang="rs"><span>#![</span><span style="color:#d54e53;">feature</span><span>(const_trait_impl)]
</span><span>#![</span><span style="color:#d54e53;">feature</span><span>(const_fn_floating_point_arithmetic)]
</span><span>#![</span><span style="color:#d54e53;">feature</span><span>(const_mut_refs)]
</span><span style="color:#c397d8;">pub mod </span><span>util;
</span><span style="color:#c397d8;">pub mod </span><span>vec3;
</span><span>
</span><span style="color:#c397d8;">pub use </span><span>vec3::</span><span style="color:#70c0b1;">*</span><span>;
</span><span>
</span><span style="color:#c397d8;">pub type </span><span>Point3 </span><span style="color:#70c0b1;">=</span><span> Vec3;
</span><span style="color:#c397d8;">pub type </span><span>Color </span><span style="color:#70c0b1;">=</span><span> Vec3;
</span></code></pre>
<h2 id="util-rs">util.rs</h2>
<p><code>util.rs</code>では<code>Vec3</code>の処理で使いたい関数の定義を行っています。具体的には<code>sqrt</code>と<code>abs</code>です。<br />
どちらも組み込みの<code>f64</code>の関数として定義されていますが<code>const fn</code>では使えないので自前で定義しました。</p>
<p>テストを除いた<code>util.rs</code>のコードです。</p>
<pre data-lang="rust" style="background-color:#000000;color:#dedede;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#c397d8;">pub const fn </span><span style="color:#7aa6da;">sqrt</span><span>(</span><span style="color:#e78c45;">s</span><span>: </span><span style="color:#c397d8;">f64</span><span>) -&gt; </span><span style="color:#c397d8;">f64 </span><span>{
</span><span>    </span><span style="color:#c397d8;">if</span><span> s </span><span style="color:#70c0b1;">== </span><span style="color:#e78c45;">0.0 </span><span>{
</span><span>        </span><span style="color:#c397d8;">return </span><span style="color:#e78c45;">0.0</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#c397d8;">let mut</span><span> x </span><span style="color:#70c0b1;">=</span><span> s </span><span style="color:#70c0b1;">/ </span><span style="color:#e78c45;">2.0</span><span>;
</span><span>    </span><span style="color:#c397d8;">let mut</span><span> _last_x </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">0.0</span><span>;
</span><span>
</span><span>    </span><span style="color:#c397d8;">while</span><span> x </span><span style="color:#70c0b1;">!=</span><span> _last_x {
</span><span>        _last_x </span><span style="color:#70c0b1;">=</span><span> x;
</span><span>        x </span><span style="color:#70c0b1;">= </span><span>(x </span><span style="color:#70c0b1;">+</span><span> s </span><span style="color:#70c0b1;">/</span><span> x) </span><span style="color:#70c0b1;">/ </span><span style="color:#e78c45;">2.0</span><span>;
</span><span>    }
</span><span>    x
</span><span>}
</span><span>
</span><span style="color:#c397d8;">pub const fn </span><span style="color:#7aa6da;">abs</span><span>(</span><span style="color:#e78c45;">s</span><span>: </span><span style="color:#c397d8;">f64</span><span>) -&gt; </span><span style="color:#c397d8;">f64 </span><span>{
</span><span>    </span><span style="color:#c397d8;">if</span><span> s </span><span style="color:#70c0b1;">&gt;= </span><span style="color:#e78c45;">0.0 </span><span>{
</span><span>        s
</span><span>    } </span><span style="color:#c397d8;">else </span><span>{
</span><span>        </span><span style="color:#70c0b1;">-</span><span>s
</span><span>    }
</span><span>}
</span></code></pre>
<p><code>2.0.sqrt()</code>のような形式ではなく<code>sqrt(2.0)</code>のような形式で呼び出すように実装しています。<br />
<code>sqrt</code>は標準の<code>f64::sqrt</code>と若干誤差が出てしまいますが実際に使う分には問題ない程度だと思うのでこのまま進めます。</p>
<h2 id="vec3-rs"><code>Vec3.rs</code></h2>
<p><code>vec3.rs</code>では<code>Vec3</code>とそれに関連する関数を定義しています。<br />
<code>Vec3</code>の定義は以下のようになっており、<code>x</code>, <code>y</code>, <code>z</code>には外部からもアクセスできるシンプルな作りになっています。<br />
ここに<code>Add</code>, <code>AddAssign</code>, <code>Mul</code>,<code>Index</code>などの演算子と、<code>length_squred</code>, <code>length</code> <code>dot</code>, <code>corss</code>, <code>unit_vector</code>などの関数を実装しています。<br />
(好みで言えば<code>unit_vector</code>という外部の関数よりは<code>v.normalized()</code>のような使い方ができる方が好きなのですが、<a href="https://raytracing.github.io/books/RayTracingInOneWeekend.html#thevec3class">参考元</a>がこうなっているのでこのように実装しました)</p>
<pre data-lang="rust" style="background-color:#000000;color:#dedede;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#d54e53;">derive</span><span>(Debug, PartialEq, Clone, Copy)]
</span><span style="color:#c397d8;">pub struct </span><span>Vec3 {
</span><span>    </span><span style="color:#c397d8;">pub </span><span style="color:#d54e53;">x</span><span>: </span><span style="color:#c397d8;">f64</span><span>,
</span><span>    </span><span style="color:#c397d8;">pub </span><span style="color:#d54e53;">y</span><span>: </span><span style="color:#c397d8;">f64</span><span>,
</span><span>    </span><span style="color:#c397d8;">pub </span><span style="color:#d54e53;">z</span><span>: </span><span style="color:#c397d8;">f64</span><span>,
</span><span>}
</span></code></pre>
<p>少々長いですがテストを除いたコード全文も貼っておきます</p>
<details>
<summary>Vec3のテストを除いたコード全文</summary>
<pre data-lang="rust" style="background-color:#000000;color:#dedede;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#c397d8;">use crate</span><span>::util::</span><span style="color:#70c0b1;">*</span><span>;
</span><span style="color:#c397d8;">use </span><span>std::ops::</span><span style="color:#70c0b1;">*</span><span>;
</span><span>
</span><span>#[</span><span style="color:#d54e53;">derive</span><span>(Debug, PartialEq, Copy)]
</span><span style="color:#c397d8;">pub struct </span><span>Vec3 {
</span><span>    </span><span style="color:#c397d8;">pub </span><span style="color:#d54e53;">x</span><span>: </span><span style="color:#c397d8;">f64</span><span>,
</span><span>    </span><span style="color:#c397d8;">pub </span><span style="color:#d54e53;">y</span><span>: </span><span style="color:#c397d8;">f64</span><span>,
</span><span>    </span><span style="color:#c397d8;">pub </span><span style="color:#d54e53;">z</span><span>: </span><span style="color:#c397d8;">f64</span><span>,
</span><span>}
</span><span>
</span><span style="color:#c397d8;">impl </span><span>const std::default::Default for Vec3 {
</span><span>    </span><span style="color:#c397d8;">fn </span><span style="color:#7aa6da;">default</span><span>() -&gt; </span><span style="color:#c397d8;">Self </span><span>{
</span><span>        Vec3::</span><span style="color:#eeeeee;">ZERO
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#c397d8;">impl </span><span>const Clone for Vec3 {
</span><span>    </span><span style="color:#c397d8;">fn </span><span style="color:#7aa6da;">clone</span><span>(</span><span style="color:#70c0b1;">&amp;</span><span style="color:#e78c45;">self</span><span>) -&gt; </span><span style="color:#c397d8;">Self </span><span>{
</span><span>        Vec3 {
</span><span>            x: </span><span style="color:#d54e53;">self</span><span>.x,
</span><span>            y: </span><span style="color:#d54e53;">self</span><span>.y,
</span><span>            z: </span><span style="color:#d54e53;">self</span><span>.z,
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#c397d8;">fn </span><span style="color:#7aa6da;">clone_from</span><span>(</span><span style="color:#70c0b1;">&amp;</span><span style="color:#c397d8;">mut </span><span style="color:#e78c45;">self</span><span>, </span><span style="color:#e78c45;">source</span><span>: </span><span style="color:#70c0b1;">&amp;</span><span style="color:#c397d8;">Self</span><span>) {
</span><span>        </span><span style="color:#70c0b1;">*</span><span style="color:#d54e53;">self </span><span style="color:#70c0b1;">=</span><span> Vec3 {
</span><span>            x: source.x,
</span><span>            y: source.y,
</span><span>            z: source.z,
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#c397d8;">impl </span><span>Vec3 {
</span><span>    </span><span style="color:#c397d8;">pub const </span><span style="color:#eeeeee;">ZERO</span><span>: Vec3 </span><span style="color:#70c0b1;">= </span><span>Vec3::new(</span><span style="color:#e78c45;">0.0</span><span>, </span><span style="color:#e78c45;">0.0</span><span>, </span><span style="color:#e78c45;">0.0</span><span>);
</span><span>
</span><span>    </span><span style="color:#c397d8;">pub const fn </span><span style="color:#7aa6da;">new</span><span>(</span><span style="color:#e78c45;">x</span><span>: </span><span style="color:#c397d8;">f64</span><span>, </span><span style="color:#e78c45;">y</span><span>: </span><span style="color:#c397d8;">f64</span><span>, </span><span style="color:#e78c45;">z</span><span>: </span><span style="color:#c397d8;">f64</span><span>) -&gt; </span><span style="color:#c397d8;">Self </span><span>{
</span><span>        </span><span style="color:#c397d8;">Self </span><span>{ x, y, z }
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#c397d8;">pub const fn </span><span style="color:#7aa6da;">length_squared</span><span>(</span><span style="color:#70c0b1;">&amp;</span><span style="color:#e78c45;">self</span><span>) -&gt; </span><span style="color:#c397d8;">f64 </span><span>{
</span><span>        </span><span style="color:#d54e53;">self</span><span>.x </span><span style="color:#70c0b1;">* </span><span style="color:#d54e53;">self</span><span>.x </span><span style="color:#70c0b1;">+ </span><span style="color:#d54e53;">self</span><span>.y </span><span style="color:#70c0b1;">* </span><span style="color:#d54e53;">self</span><span>.y </span><span style="color:#70c0b1;">+ </span><span style="color:#d54e53;">self</span><span>.z </span><span style="color:#70c0b1;">* </span><span style="color:#d54e53;">self</span><span>.z
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#c397d8;">pub const fn </span><span style="color:#7aa6da;">length</span><span>(</span><span style="color:#70c0b1;">&amp;</span><span style="color:#e78c45;">self</span><span>) -&gt; </span><span style="color:#c397d8;">f64 </span><span>{
</span><span>        </span><span style="color:#7aa6da;">sqrt</span><span>(</span><span style="color:#d54e53;">self</span><span>.</span><span style="color:#7aa6da;">length_squared</span><span>())
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#c397d8;">impl </span><span>const Neg for Vec3 {
</span><span>    </span><span style="color:#c397d8;">type </span><span>Output </span><span style="color:#70c0b1;">= </span><span style="color:#c397d8;">Self</span><span>;
</span><span>    </span><span style="color:#c397d8;">fn </span><span style="color:#7aa6da;">neg</span><span>(</span><span style="color:#e78c45;">self</span><span>) -&gt; </span><span style="color:#c397d8;">Self::</span><span>Output {
</span><span>        Vec3::new(</span><span style="color:#70c0b1;">-</span><span style="color:#d54e53;">self</span><span>.x, </span><span style="color:#70c0b1;">-</span><span style="color:#d54e53;">self</span><span>.y, </span><span style="color:#70c0b1;">-</span><span style="color:#d54e53;">self</span><span>.z)
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#c397d8;">impl </span><span>const Index&lt;</span><span style="color:#c397d8;">usize</span><span>&gt; for Vec3 {
</span><span>    </span><span style="color:#c397d8;">type </span><span>Output </span><span style="color:#70c0b1;">= </span><span style="color:#c397d8;">f64</span><span>;
</span><span>
</span><span>    </span><span style="color:#c397d8;">fn </span><span style="color:#7aa6da;">index</span><span>(</span><span style="color:#70c0b1;">&amp;</span><span style="color:#e78c45;">self</span><span>, </span><span style="color:#e78c45;">index</span><span>: </span><span style="color:#c397d8;">usize</span><span>) -&gt; </span><span style="color:#70c0b1;">&amp;</span><span style="color:#c397d8;">Self::</span><span>Output {
</span><span>        </span><span style="color:#c397d8;">match</span><span> index {
</span><span>            </span><span style="color:#e78c45;">0 </span><span style="color:#70c0b1;">=&gt; &amp;</span><span style="color:#d54e53;">self</span><span>.x,
</span><span>            </span><span style="color:#e78c45;">1 </span><span style="color:#70c0b1;">=&gt; &amp;</span><span style="color:#d54e53;">self</span><span>.y,
</span><span>            </span><span style="color:#e78c45;">2 </span><span style="color:#70c0b1;">=&gt; &amp;</span><span style="color:#d54e53;">self</span><span>.z,
</span><span>            </span><span style="color:#70c0b1;">_ =&gt; </span><span>panic!(</span><span style="color:#b9ca4a;">&quot;out of range&quot;</span><span>),
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#c397d8;">impl </span><span>const IndexMut&lt;</span><span style="color:#c397d8;">usize</span><span>&gt; for Vec3 {
</span><span>    </span><span style="color:#c397d8;">fn </span><span style="color:#7aa6da;">index_mut</span><span>(</span><span style="color:#70c0b1;">&amp;</span><span style="color:#c397d8;">mut </span><span style="color:#e78c45;">self</span><span>, </span><span style="color:#e78c45;">index</span><span>: </span><span style="color:#c397d8;">usize</span><span>) -&gt; </span><span style="color:#70c0b1;">&amp;</span><span style="color:#c397d8;">mut Self::</span><span>Output {
</span><span>        </span><span style="color:#c397d8;">match</span><span> index {
</span><span>            </span><span style="color:#e78c45;">0 </span><span style="color:#70c0b1;">=&gt; &amp;</span><span style="color:#c397d8;">mut </span><span style="color:#d54e53;">self</span><span>.x,
</span><span>            </span><span style="color:#e78c45;">1 </span><span style="color:#70c0b1;">=&gt; &amp;</span><span style="color:#c397d8;">mut </span><span style="color:#d54e53;">self</span><span>.y,
</span><span>            </span><span style="color:#e78c45;">2 </span><span style="color:#70c0b1;">=&gt; &amp;</span><span style="color:#c397d8;">mut </span><span style="color:#d54e53;">self</span><span>.z,
</span><span>            </span><span style="color:#70c0b1;">_ =&gt; </span><span>panic!(</span><span style="color:#b9ca4a;">&quot;out of range&quot;</span><span>),
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#c397d8;">impl </span><span>const Add&lt;Vec3&gt; for Vec3 {
</span><span>    </span><span style="color:#c397d8;">type </span><span>Output </span><span style="color:#70c0b1;">= </span><span style="color:#c397d8;">Self</span><span>;
</span><span>
</span><span>    </span><span style="color:#c397d8;">fn </span><span style="color:#7aa6da;">add</span><span>(</span><span style="color:#e78c45;">self</span><span>, </span><span style="color:#e78c45;">rhs</span><span>: Vec3) -&gt; </span><span style="color:#c397d8;">Self::</span><span>Output {
</span><span>        Vec3 {
</span><span>            x: </span><span style="color:#d54e53;">self</span><span>.x </span><span style="color:#70c0b1;">+</span><span> rhs.x,
</span><span>            y: </span><span style="color:#d54e53;">self</span><span>.y </span><span style="color:#70c0b1;">+</span><span> rhs.y,
</span><span>            z: </span><span style="color:#d54e53;">self</span><span>.z </span><span style="color:#70c0b1;">+</span><span> rhs.z,
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#c397d8;">impl </span><span>const Sub&lt;Vec3&gt; for Vec3 {
</span><span>    </span><span style="color:#c397d8;">type </span><span>Output </span><span style="color:#70c0b1;">= </span><span style="color:#c397d8;">Self</span><span>;
</span><span>
</span><span>    </span><span style="color:#c397d8;">fn </span><span style="color:#7aa6da;">sub</span><span>(</span><span style="color:#e78c45;">self</span><span>, </span><span style="color:#e78c45;">rhs</span><span>: Vec3) -&gt; </span><span style="color:#c397d8;">Self::</span><span>Output {
</span><span>        Vec3 {
</span><span>            x: </span><span style="color:#d54e53;">self</span><span>.x </span><span style="color:#70c0b1;">-</span><span> rhs.x,
</span><span>            y: </span><span style="color:#d54e53;">self</span><span>.y </span><span style="color:#70c0b1;">-</span><span> rhs.y,
</span><span>            z: </span><span style="color:#d54e53;">self</span><span>.z </span><span style="color:#70c0b1;">-</span><span> rhs.z,
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#c397d8;">impl </span><span>const Mul&lt;</span><span style="color:#c397d8;">f64</span><span>&gt; for Vec3 {
</span><span>    </span><span style="color:#c397d8;">type </span><span>Output </span><span style="color:#70c0b1;">=</span><span> Vec3;
</span><span>
</span><span>    </span><span style="color:#c397d8;">fn </span><span style="color:#7aa6da;">mul</span><span>(</span><span style="color:#e78c45;">self</span><span>, </span><span style="color:#e78c45;">rhs</span><span>: </span><span style="color:#c397d8;">f64</span><span>) -&gt; </span><span style="color:#c397d8;">Self::</span><span>Output {
</span><span>        Vec3 {
</span><span>            x: </span><span style="color:#d54e53;">self</span><span>.x </span><span style="color:#70c0b1;">*</span><span> rhs,
</span><span>            y: </span><span style="color:#d54e53;">self</span><span>.y </span><span style="color:#70c0b1;">*</span><span> rhs,
</span><span>            z: </span><span style="color:#d54e53;">self</span><span>.z </span><span style="color:#70c0b1;">*</span><span> rhs,
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#c397d8;">impl </span><span>const MulAssign&lt;</span><span style="color:#c397d8;">f64</span><span>&gt; for Vec3 {
</span><span>    </span><span style="color:#c397d8;">fn </span><span style="color:#7aa6da;">mul_assign</span><span>(</span><span style="color:#70c0b1;">&amp;</span><span style="color:#c397d8;">mut </span><span style="color:#e78c45;">self</span><span>, </span><span style="color:#e78c45;">rhs</span><span>: </span><span style="color:#c397d8;">f64</span><span>) {
</span><span>        </span><span style="color:#70c0b1;">*</span><span style="color:#d54e53;">self </span><span style="color:#70c0b1;">= *</span><span style="color:#d54e53;">self </span><span style="color:#70c0b1;">*</span><span> rhs;
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#c397d8;">impl </span><span>const Div&lt;</span><span style="color:#c397d8;">f64</span><span>&gt; for Vec3 {
</span><span>    </span><span style="color:#c397d8;">type </span><span>Output </span><span style="color:#70c0b1;">=</span><span> Vec3;
</span><span>
</span><span>    </span><span style="color:#c397d8;">fn </span><span style="color:#7aa6da;">div</span><span>(</span><span style="color:#e78c45;">self</span><span>, </span><span style="color:#e78c45;">rhs</span><span>: </span><span style="color:#c397d8;">f64</span><span>) -&gt; </span><span style="color:#c397d8;">Self::</span><span>Output {
</span><span>        Vec3 {
</span><span>            x: </span><span style="color:#d54e53;">self</span><span>.x </span><span style="color:#70c0b1;">/</span><span> rhs,
</span><span>            y: </span><span style="color:#d54e53;">self</span><span>.y </span><span style="color:#70c0b1;">/</span><span> rhs,
</span><span>            z: </span><span style="color:#d54e53;">self</span><span>.z </span><span style="color:#70c0b1;">/</span><span> rhs,
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#c397d8;">impl </span><span>const DivAssign&lt;</span><span style="color:#c397d8;">f64</span><span>&gt; for Vec3 {
</span><span>    </span><span style="color:#c397d8;">fn </span><span style="color:#7aa6da;">div_assign</span><span>(</span><span style="color:#70c0b1;">&amp;</span><span style="color:#c397d8;">mut </span><span style="color:#e78c45;">self</span><span>, </span><span style="color:#e78c45;">rhs</span><span>: </span><span style="color:#c397d8;">f64</span><span>) {
</span><span>        </span><span style="color:#70c0b1;">*</span><span style="color:#d54e53;">self </span><span style="color:#70c0b1;">= *</span><span style="color:#d54e53;">self </span><span style="color:#70c0b1;">/</span><span> rhs;
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#c397d8;">impl </span><span>const Mul&lt;Vec3&gt; for f64 {
</span><span>    </span><span style="color:#c397d8;">type </span><span>Output </span><span style="color:#70c0b1;">=</span><span> Vec3;
</span><span>
</span><span>    </span><span style="color:#c397d8;">fn </span><span style="color:#7aa6da;">mul</span><span>(</span><span style="color:#e78c45;">self</span><span>, </span><span style="color:#e78c45;">rhs</span><span>: Vec3) -&gt; </span><span style="color:#c397d8;">Self::</span><span>Output {
</span><span>        rhs </span><span style="color:#70c0b1;">* </span><span style="color:#d54e53;">self
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#c397d8;">impl </span><span>const Div&lt;Vec3&gt; for f64 {
</span><span>    </span><span style="color:#c397d8;">type </span><span>Output </span><span style="color:#70c0b1;">=</span><span> Vec3;
</span><span>
</span><span>    </span><span style="color:#c397d8;">fn </span><span style="color:#7aa6da;">div</span><span>(</span><span style="color:#e78c45;">self</span><span>, </span><span style="color:#e78c45;">rhs</span><span>: Vec3) -&gt; </span><span style="color:#c397d8;">Self::</span><span>Output {
</span><span>        rhs </span><span style="color:#70c0b1;">/ </span><span style="color:#d54e53;">self
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#c397d8;">pub const fn </span><span style="color:#7aa6da;">dot</span><span>(</span><span style="color:#e78c45;">u</span><span>: </span><span style="color:#70c0b1;">&amp;</span><span>Vec3, </span><span style="color:#e78c45;">v</span><span>: </span><span style="color:#70c0b1;">&amp;</span><span>Vec3) -&gt; </span><span style="color:#c397d8;">f64 </span><span>{
</span><span>    u.x </span><span style="color:#70c0b1;">*</span><span> v.x </span><span style="color:#70c0b1;">+</span><span> u.y </span><span style="color:#70c0b1;">*</span><span> v.y </span><span style="color:#70c0b1;">+</span><span> u.z </span><span style="color:#70c0b1;">*</span><span> v.z
</span><span>}
</span><span>
</span><span style="color:#c397d8;">pub const fn </span><span style="color:#7aa6da;">cross</span><span>(</span><span style="color:#e78c45;">u</span><span>: </span><span style="color:#70c0b1;">&amp;</span><span>Vec3, </span><span style="color:#e78c45;">v</span><span>: </span><span style="color:#70c0b1;">&amp;</span><span>Vec3) -&gt; Vec3 {
</span><span>    Vec3::new(
</span><span>        u.y </span><span style="color:#70c0b1;">*</span><span> v.z </span><span style="color:#70c0b1;">-</span><span> u.z </span><span style="color:#70c0b1;">*</span><span> v.y,
</span><span>        u.z </span><span style="color:#70c0b1;">*</span><span> v.x </span><span style="color:#70c0b1;">-</span><span> u.x </span><span style="color:#70c0b1;">*</span><span> v.z,
</span><span>        u.x </span><span style="color:#70c0b1;">*</span><span> v.y </span><span style="color:#70c0b1;">-</span><span> u.y </span><span style="color:#70c0b1;">*</span><span> v.x,
</span><span>    )
</span><span>}
</span><span>
</span><span style="color:#c397d8;">pub const fn </span><span style="color:#7aa6da;">unit_vector</span><span>(</span><span style="color:#e78c45;">v</span><span>: </span><span style="color:#70c0b1;">&amp;</span><span>Vec3) -&gt; Vec3 {
</span><span>    </span><span style="color:#c397d8;">let</span><span> len </span><span style="color:#70c0b1;">=</span><span> v.</span><span style="color:#7aa6da;">length</span><span>();
</span><span>    </span><span style="color:#c397d8;">if </span><span>std::f64::</span><span style="color:#eeeeee;">EPSILON </span><span style="color:#70c0b1;">&lt; </span><span style="color:#7aa6da;">abs</span><span>(len) {
</span><span>        </span><span style="color:#70c0b1;">*</span><span>v </span><span style="color:#70c0b1;">/</span><span> len
</span><span>    } </span><span style="color:#c397d8;">else </span><span>{
</span><span>        Vec3::</span><span style="color:#eeeeee;">ZERO
</span><span>    }
</span><span>}
</span></code></pre>
</details>
<h2 id="main-rsnobian-geng-dian">main.rsの変更点</h2>
<p><code>main.rs</code>でピクセルの色として使用していた<code>(f64, f64, f64)</code>を<code>Color</code>(<code>Vec3</code>)型に置き換えました。<br />
また<code>(f64, f64, f64)</code>から<code>(u8, u8, u8)</code>に変換する処理を<code>pixels_to_buffer()</code>関数に移動するなどの細かい変更もしています。</p>
<details>
<summary>main.rs全文</summary>
<pre data-lang="rust" style="background-color:#000000;color:#dedede;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#![</span><span style="color:#d54e53;">feature</span><span>(const_fn_floating_point_arithmetic)] </span><span style="color:#999999;">// const fnの中で浮動小数点演算を行うために必要
</span><span>
</span><span style="color:#c397d8;">use </span><span>image::ImageFormat;
</span><span style="color:#c397d8;">use </span><span>ray_tracing_in_one_weekend_compile_time::Color;
</span><span>
</span><span style="color:#c397d8;">const </span><span style="color:#eeeeee;">IMAGE_WIDTH</span><span>: </span><span style="color:#c397d8;">usize </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">256</span><span>;
</span><span style="color:#c397d8;">const </span><span style="color:#eeeeee;">IMAGE_HEIGHT</span><span>: </span><span style="color:#c397d8;">usize </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">256</span><span>;
</span><span style="color:#c397d8;">const </span><span style="color:#eeeeee;">PIXEL_COUNT</span><span>: </span><span style="color:#c397d8;">usize </span><span style="color:#70c0b1;">= </span><span style="color:#eeeeee;">IMAGE_WIDTH </span><span style="color:#70c0b1;">* </span><span style="color:#eeeeee;">IMAGE_HEIGHT</span><span>;
</span><span>
</span><span style="color:#c397d8;">fn </span><span style="color:#7aa6da;">main</span><span>() -&gt; anyhow::</span><span style="color:#e7c547;">Result</span><span>&lt;()&gt; {
</span><span>    </span><span style="color:#c397d8;">const </span><span style="color:#eeeeee;">PIXEL_COLORS</span><span>: [Color; </span><span style="color:#eeeeee;">PIXEL_COUNT</span><span>] </span><span style="color:#70c0b1;">= </span><span style="color:#7aa6da;">ray_trace</span><span>();
</span><span>    </span><span style="color:#c397d8;">const </span><span style="color:#eeeeee;">BUFFER</span><span>: [</span><span style="color:#c397d8;">u8</span><span>; </span><span style="color:#eeeeee;">PIXEL_COUNT </span><span style="color:#70c0b1;">* </span><span style="color:#e78c45;">3</span><span>] </span><span style="color:#70c0b1;">= </span><span style="color:#7aa6da;">pixels_to_buffer</span><span>(</span><span style="color:#eeeeee;">PIXEL_COLORS</span><span>);
</span><span>    </span><span style="color:#c397d8;">let</span><span> img </span><span style="color:#70c0b1;">= </span><span>image::RgbImage::from_raw(</span><span style="color:#eeeeee;">IMAGE_WIDTH </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">u32</span><span>, </span><span style="color:#eeeeee;">IMAGE_HEIGHT </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">u32</span><span>, </span><span style="color:#eeeeee;">BUFFER</span><span>.</span><span style="color:#7aa6da;">to_vec</span><span>())
</span><span>        .</span><span style="color:#7aa6da;">unwrap</span><span>();
</span><span>    img.</span><span style="color:#7aa6da;">save_with_format</span><span>(</span><span style="color:#b9ca4a;">&quot;./result.png&quot;</span><span>, ImageFormat::Png)</span><span style="color:#70c0b1;">?</span><span>;
</span><span>
</span><span>    </span><span style="color:#e7c547;">Ok</span><span>(())
</span><span>}
</span><span>
</span><span style="color:#c397d8;">const fn </span><span style="color:#7aa6da;">ray_trace</span><span>() -&gt; [Color; </span><span style="color:#eeeeee;">PIXEL_COUNT</span><span>] {
</span><span>    </span><span style="color:#c397d8;">let mut</span><span> pixel_colors </span><span style="color:#70c0b1;">= </span><span>[Color::</span><span style="color:#eeeeee;">ZERO</span><span>; </span><span style="color:#eeeeee;">PIXEL_COUNT</span><span>];
</span><span>    </span><span style="color:#c397d8;">let mut</span><span> i </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">0</span><span>;
</span><span>    </span><span style="color:#c397d8;">let mut</span><span> j </span><span style="color:#70c0b1;">= </span><span>(</span><span style="color:#eeeeee;">IMAGE_HEIGHT </span><span style="color:#70c0b1;">- </span><span style="color:#e78c45;">1</span><span>) </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">i32</span><span>;
</span><span>    </span><span style="color:#999999;">// forが使えないのでwhileで代用
</span><span>    </span><span style="color:#c397d8;">while </span><span style="color:#e78c45;">0 </span><span style="color:#70c0b1;">&lt;=</span><span> j {
</span><span>        </span><span style="color:#c397d8;">while</span><span> i </span><span style="color:#70c0b1;">&lt; </span><span style="color:#eeeeee;">IMAGE_WIDTH </span><span>{
</span><span>            pixel_colors[j </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">usize </span><span style="color:#70c0b1;">* </span><span style="color:#eeeeee;">IMAGE_WIDTH </span><span style="color:#70c0b1;">+</span><span> i] </span><span style="color:#70c0b1;">= </span><span>Color::new(
</span><span>                (i </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">f64</span><span>) </span><span style="color:#70c0b1;">/ </span><span>((</span><span style="color:#eeeeee;">IMAGE_WIDTH </span><span style="color:#70c0b1;">- </span><span style="color:#e78c45;">1</span><span>) </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">f64</span><span>),
</span><span>                j </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">f64 </span><span style="color:#70c0b1;">/ </span><span>(</span><span style="color:#eeeeee;">IMAGE_HEIGHT </span><span style="color:#70c0b1;">- </span><span style="color:#e78c45;">1</span><span>) </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">f64</span><span>,
</span><span>                </span><span style="color:#e78c45;">0.25</span><span>,
</span><span>            );
</span><span>            i </span><span style="color:#70c0b1;">+= </span><span style="color:#e78c45;">1</span><span>;
</span><span>        }
</span><span>        i </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">0</span><span>;
</span><span>        j </span><span style="color:#70c0b1;">-= </span><span style="color:#e78c45;">1</span><span>;
</span><span>    }
</span><span>    pixel_colors
</span><span>}
</span><span>
</span><span style="color:#c397d8;">const fn </span><span style="color:#7aa6da;">pixels_to_buffer</span><span>(</span><span style="color:#e78c45;">pixels</span><span>: [Color; PIXEL_COUNT]) -&gt; [</span><span style="color:#c397d8;">u8</span><span>; </span><span style="color:#eeeeee;">PIXEL_COUNT </span><span style="color:#70c0b1;">* </span><span style="color:#e78c45;">3</span><span>] {
</span><span>    </span><span style="color:#999999;">//let buf: Vec&lt;_&gt; = PIXEL_COLORS
</span><span>    </span><span style="color:#999999;">//    .iter()
</span><span>    </span><span style="color:#999999;">//    .map(|&amp;(r, g, b)| (r * 255.999, g * 255.999, b * 255.999))
</span><span>    </span><span style="color:#999999;">//    .map(|&amp;(r, g, b)| [r as u8, g as u8, b as u8])
</span><span>    </span><span style="color:#999999;">//    .flatten()
</span><span>    </span><span style="color:#999999;">//    .collect();
</span><span>    </span><span style="color:#999999;">//buf
</span><span>
</span><span>    </span><span style="color:#999999;">// 上と同じことをしている
</span><span>    </span><span style="color:#c397d8;">let mut</span><span> buf </span><span style="color:#70c0b1;">= </span><span>[</span><span style="color:#e78c45;">0</span><span>; </span><span style="color:#eeeeee;">PIXEL_COUNT </span><span style="color:#70c0b1;">* </span><span style="color:#e78c45;">3</span><span>];
</span><span>    </span><span style="color:#c397d8;">let mut</span><span> i </span><span style="color:#70c0b1;">= </span><span style="color:#e78c45;">0</span><span>;
</span><span>    </span><span style="color:#c397d8;">while</span><span> i </span><span style="color:#70c0b1;">&lt; </span><span style="color:#eeeeee;">PIXEL_COUNT </span><span>{
</span><span>        buf[i </span><span style="color:#70c0b1;">* </span><span style="color:#e78c45;">3 </span><span style="color:#70c0b1;">+ </span><span style="color:#e78c45;">0</span><span>] </span><span style="color:#70c0b1;">= </span><span>(pixels[i].x </span><span style="color:#70c0b1;">* </span><span style="color:#e78c45;">255.999</span><span>) </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">u8</span><span>;
</span><span>        buf[i </span><span style="color:#70c0b1;">* </span><span style="color:#e78c45;">3 </span><span style="color:#70c0b1;">+ </span><span style="color:#e78c45;">1</span><span>] </span><span style="color:#70c0b1;">= </span><span>(pixels[i].y </span><span style="color:#70c0b1;">* </span><span style="color:#e78c45;">255.999</span><span>) </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">u8</span><span>;
</span><span>        buf[i </span><span style="color:#70c0b1;">* </span><span style="color:#e78c45;">3 </span><span style="color:#70c0b1;">+ </span><span style="color:#e78c45;">2</span><span>] </span><span style="color:#70c0b1;">= </span><span>(pixels[i].z </span><span style="color:#70c0b1;">* </span><span style="color:#e78c45;">255.999</span><span>) </span><span style="color:#70c0b1;">as </span><span style="color:#c397d8;">u8</span><span>;
</span><span>        i </span><span style="color:#70c0b1;">+= </span><span style="color:#e78c45;">1</span><span>;
</span><span>    }
</span><span>    buf
</span><span>}
</span></code></pre>
</details>
<h2 id="matome">まとめ</h2>
<p>今回追加したコードも<code>faature</code>の使用は必要ですがほぼ通常通りの書き方で書けました。<br />
<code>abs</code>や<code>sqrt</code>なんかの処理を自前で定義するのは面倒&amp;不安なので標準のものを<code>const fn</code>で使用できるようになって欲しいです。</p>
<hr />
<p>次回はレイトレーシングっぽい処理が追加されるはずです。</p>
</p>
<hr>
<p class="share_buttons">
  <a class="twitter-share-button" data-text="Rustでコンパイル時レイトレーシング2 - blockの巣" href="https://twitter.com/intent/tweet">Tweet</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</p>

  <script src="https://codoc.jp/js/cms.js" data-css="blue" data-usercode="a1YRHEx5Vg" charset="UTF-8" defer></script>
<div id="codoc-entry-Jrk5cYu5tw" class="codoc-entries" data-without-body="1" data-support-message="よければ支援をお願いいたします"></div>



    </div>
  </section>
  <footer>
    
    
    copyright 2019 block.
    
    
  </footer>

  
  <script>
    const ga_tracking_id = "G-HH0FEX22FQ";
    const ga_accept_message = `<ul>
<li>当サイトではアクセス解析ツールGoogle Analyticsを使用しています</li>
<li>Google Analyticsはトラフィックデータの収集のためにCookieを使用します</li>
<li>データ収集の同意の状態はPrivacy Policyからいつでもリセットできます</li>
<li>サイトの閲覧数などを確認したいので同意していただけると嬉しいです</li>
</ul>
`;
    const privacy_policy_url = "https://block-cube-lib.github.io/privacy-policy/";
  </script>
  <script src="https://block-cube-lib.github.io/js/ga-cookie-accept.js"></script>
  
</body>

</html>
