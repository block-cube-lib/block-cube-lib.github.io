<!DOCTYPE html>
<head>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-148823095-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-148823095-1');
    window['ga-disable-UA-148823095-1'] = true;
  </script>
  
  <title>
    
      const fnで使用可能なVec3を定義する - blockの巣
    
  </title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" constnt="この記事はRust v1.60.0-nightlyで動作確認しています。

今私はRustでコンパイル時レイトレーシングという試みをしているのですが…">

   <!-- begin ogp -->
    <meta property="og:url" content="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;blog&#x2F;const-vec3&#x2F;">
    <meta property="og:image" content="https://j3mhco9ey2.execute-api.us-east-2.amazonaws.com/default/ogp_image_generator?encoded_url=aHR0cHM6Ly9ibG9jay1jdWJlLWxpYi5naXRodWIuaW8vYmxvZy9jb25zdC12ZWMzLw==">
    <meta property="og:title" content= "const fnで使用可能なVec3を定義する" >
    
    
      
          <meta property="og:type" constnt="article">
      
    
    <meta name="og:description" constnt="この記事はRust v1.60.0-nightlyで動作確認しています。

今私はRustでコンパイル時レイトレーシングという試みをしているのですが…">
    <!-- begin twitter ogp -->
    
      <meta property="twitter:card" content="summary_large_image">
      <meta property="twitter:site" content="@block_cube_lib">
      <meta property="twitter:title" content= "const fnで使用可能なVec3を定義する" >
    
    <!-- end twitter ogp -->
   <!-- end ogp -->
  <link rel="stylesheet" type="text/css" href="https://block-cube-lib.github.io/style.css">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
</head>

<body>
  <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
  <header class="header">
    
    <div class="container" id="ga_cookie_accept_menu"></div>
    
    <div class="container">
      <a href="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;">blockの巣</a>
      <nav>
        
        <a class="nav_content" href="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;blog&#x2F;">Blog</a>
        
        <a class="nav_content" href="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;tags&#x2F;">Tags</a>
        
        <a class="nav_content" href="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;about&#x2F;">About</a>
        
        <a class="nav_content" href="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;works&#x2F;">Works</a>
        
        <a class="nav_content" href="https:&#x2F;&#x2F;block-cube-lib.github.io&#x2F;privacy-policy&#x2F;">Privacy Policy</a>
        
      </nav>
    </div>
  </header>
  <section class="section">
    <div class="container">
      
<h1 class="title">
  const fnで使用可能なVec3を定義する
</h1>

  <span class = "date">2022&#x2F;01&#x2F;27 13:25</span>

<section class="tags">
  
  
  
  <span class = "tag">
    <a href="https://block-cube-lib.github.io/tags/rust/">Rust</a> 
  </span>

  

</section>
<p><p>この記事はRust v1.60.0-nightlyで動作確認しています。</p>
<hr />
<p>今私はRustでコンパイル時レイトレーシングという試みをしているのですが、そこで必要になった<code>const fn</code>の中で使用できる<code>Vec3</code>を定義するためのに必要なことを書いていきます。<br />
都度Rust Playgroundへのリンクを張っていますが、コンパイルに時間がかかることがありRust Playgroundではタイムアウトするかもしれません。</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">struct </span><span>Vec3 {
</span><span>  </span><span style="color:#bf616a;">x</span><span>: </span><span style="color:#b48ead;">f64</span><span>,
</span><span>  </span><span style="color:#bf616a;">y</span><span>: </span><span style="color:#b48ead;">f64</span><span>,
</span><span>  </span><span style="color:#bf616a;">z</span><span>: </span><span style="color:#b48ead;">f64</span><span>,
</span><span>}
</span></code></pre>
<p>このような<code>Vec3</code>があるとして<code>const fn</code>の中で</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">const fn </span><span style="color:#8fa1b3;">const_function</span><span>() {
</span><span>  </span><span style="color:#b48ead;">let mut</span><span> v1: Vec3 = Vec3 { x: </span><span style="color:#d08770;">1.0</span><span>, y: </span><span style="color:#d08770;">2.0</span><span>, z: </span><span style="color:#d08770;">3.0 </span><span>};
</span><span>  </span><span style="color:#b48ead;">let</span><span> v2: Vec3 = Vec3 { x: </span><span style="color:#d08770;">2.0</span><span>, y: </span><span style="color:#d08770;">3.0</span><span>, z: </span><span style="color:#d08770;">4.0 </span><span>};
</span><span>
</span><span>  </span><span style="color:#b48ead;">let </span><span>_ = v1 + v2; </span><span style="color:#65737e;">// Add
</span><span>  v += Vec3 { x: </span><span style="color:#d08770;">2.0</span><span>, y: </span><span style="color:#d08770;">3.0</span><span>, z: </span><span style="color:#d08770;">4.0 </span><span>}; </span><span style="color:#65737e;">// AddAssign
</span><span>  v[</span><span style="color:#d08770;">0</span><span>] = </span><span style="color:#d08770;">0.0</span><span>; </span><span style="color:#65737e;">// IndexMut
</span><span>}
</span></code></pre>
<p>上記のようなことができるようにします。</p>
<h2 id="add">Add</h2>
<p>まず<code>const fn</code>の中で動く<code>Add</code>を定義してみます。</p>
<p>下記のように通常のAddを定義して<code>const fn</code>の中で使ってみたものをコンパイルしてみると</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">use </span><span>std::ops::*;
</span><span>
</span><span style="color:#b48ead;">struct </span><span>Vec3 {
</span><span>    </span><span style="color:#bf616a;">x</span><span>: </span><span style="color:#b48ead;">f64</span><span>,
</span><span>    </span><span style="color:#bf616a;">y</span><span>: </span><span style="color:#b48ead;">f64</span><span>,
</span><span>    </span><span style="color:#bf616a;">z</span><span>: </span><span style="color:#b48ead;">f64</span><span>,
</span><span>}
</span><span>
</span><span style="color:#b48ead;">impl </span><span>Add&lt;Vec3&gt; </span><span style="color:#b48ead;">for </span><span>Vec3 {
</span><span>    </span><span style="color:#b48ead;">type </span><span>Output = </span><span style="color:#b48ead;">Self</span><span>;
</span><span>
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">add</span><span>(</span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">rhs</span><span>: Vec3) -&gt; </span><span style="color:#b48ead;">Self::</span><span>Output {
</span><span>        Vec3 {
</span><span>            x: </span><span style="color:#bf616a;">self</span><span>.x + rhs.x,
</span><span>            y: </span><span style="color:#bf616a;">self</span><span>.y + rhs.y,
</span><span>            z: </span><span style="color:#bf616a;">self</span><span>.z + rhs.z,
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#b48ead;">const fn </span><span style="color:#8fa1b3;">const_function</span><span>() {
</span><span>  </span><span style="color:#b48ead;">let</span><span> v1: Vec3 = Vec3 { x: </span><span style="color:#d08770;">1.0</span><span>, y: </span><span style="color:#d08770;">2.0</span><span>, z: </span><span style="color:#d08770;">3.0 </span><span>};
</span><span>  </span><span style="color:#b48ead;">let</span><span> v2: Vec3 = Vec3 { x: </span><span style="color:#d08770;">2.0</span><span>, y: </span><span style="color:#d08770;">3.0</span><span>, z: </span><span style="color:#d08770;">4.0 </span><span>};
</span><span>
</span><span>  </span><span style="color:#b48ead;">let </span><span>_ = v1 + v2; </span><span style="color:#65737e;">// Add
</span><span>}
</span></code></pre>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>   Compiling playground v0.0.1 (/playground)
</span><span>error[E0015]: calls in constant functions are limited to constant functions, tuple structs and tuple variants
</span><span>  --&gt; src/lib.rs:25:11
</span><span>   |
</span><span>25 |   let _ = v1 + v2; // Add
</span><span>   |           ^^^^^^^
</span><span>
</span><span>For more information about this error, try `rustc --explain E0015`.
</span><span>error: could not compile `playground` due to previous error
</span></code></pre>
<p>のようなコンパイルエラーが発生します。<br />
<a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=d38c5e6a1b249cb7743df7cbe20c2c44">Rust Playgroundで確認</a></p>
<p>まず<code>Add</code> Traitの実装を<code>const fn</code>としてできるように<code>#![feature(const_trait_impl)]</code>を追記し、<br />
<code>impl Add&lt;Vec3&gt; for Vec3</code>を<code>impl const Add&lt;Vec3&gt; for Vec3</code>に書き換えます。</p>
<details>
<summary>コード全文</summary>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#![</span><span style="color:#bf616a;">feature</span><span>(const_trait_impl)]
</span><span style="color:#b48ead;">use </span><span>std::ops::*;
</span><span>
</span><span style="color:#b48ead;">struct </span><span>Vec3 {
</span><span>    </span><span style="color:#bf616a;">x</span><span>: </span><span style="color:#b48ead;">f64</span><span>,
</span><span>    </span><span style="color:#bf616a;">y</span><span>: </span><span style="color:#b48ead;">f64</span><span>,
</span><span>    </span><span style="color:#bf616a;">z</span><span>: </span><span style="color:#b48ead;">f64</span><span>,
</span><span>}
</span><span>
</span><span style="color:#b48ead;">impl </span><span>const Add&lt;Vec3&gt; for Vec3 {
</span><span>    </span><span style="color:#b48ead;">type </span><span>Output = </span><span style="color:#b48ead;">Self</span><span>;
</span><span>
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">add</span><span>(</span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">rhs</span><span>: Vec3) -&gt; </span><span style="color:#b48ead;">Self::</span><span>Output {
</span><span>        Vec3 {
</span><span>            x: </span><span style="color:#bf616a;">self</span><span>.x + rhs.x,
</span><span>            y: </span><span style="color:#bf616a;">self</span><span>.y + rhs.y,
</span><span>            z: </span><span style="color:#bf616a;">self</span><span>.z + rhs.z,
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#b48ead;">const fn </span><span style="color:#8fa1b3;">const_function</span><span>() {
</span><span>  </span><span style="color:#b48ead;">let</span><span> v1: Vec3 = Vec3 { x: </span><span style="color:#d08770;">1.0</span><span>, y: </span><span style="color:#d08770;">2.0</span><span>, z: </span><span style="color:#d08770;">3.0 </span><span>};
</span><span>  </span><span style="color:#b48ead;">let</span><span> v2: Vec3 = Vec3 { x: </span><span style="color:#d08770;">2.0</span><span>, y: </span><span style="color:#d08770;">3.0</span><span>, z: </span><span style="color:#d08770;">4.0 </span><span>};
</span><span>
</span><span>  </span><span style="color:#b48ead;">let </span><span>_ = v1 + v2; </span><span style="color:#65737e;">// Add
</span><span>}
</span></code></pre>
</details>
<p>すると今度はこのようなエラーが出ます。</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>   Compiling playground v0.0.1 (/playground)
</span><span>error[E0658]: floating point arithmetic is not allowed in constant functions
</span><span>  --&gt; src/lib.rs:15:16
</span><span>   |
</span><span>15 |             x: self.x + rhs.x,
</span><span>   |                ^^^^^^^^^^^^^^
</span><span>   |
</span><span>   = note: see issue #57241 &lt;https://github.com/rust-lang/rust/issues/57241&gt; for more information
</span><span>   = help: add `#![feature(const_fn_floating_point_arithmetic)]` to the crate attributes to enable
</span><span>
</span><span>error[E0658]: floating point arithmetic is not allowed in constant functions
</span><span>  --&gt; src/lib.rs:16:16
</span><span>   |
</span><span>16 |             y: self.y + rhs.y,
</span><span>   |                ^^^^^^^^^^^^^^
</span><span>   |
</span><span>   = note: see issue #57241 &lt;https://github.com/rust-lang/rust/issues/57241&gt; for more information
</span><span>   = help: add `#![feature(const_fn_floating_point_arithmetic)]` to the crate attributes to enable
</span><span>
</span><span>error[E0658]: floating point arithmetic is not allowed in constant functions
</span><span>  --&gt; src/lib.rs:17:16
</span><span>   |
</span><span>17 |             z: self.z + rhs.z,
</span><span>   |                ^^^^^^^^^^^^^^
</span><span>   |
</span><span>   = note: see issue #57241 &lt;https://github.com/rust-lang/rust/issues/57241&gt; for more information
</span><span>   = help: add `#![feature(const_fn_floating_point_arithmetic)]` to the crate attributes to enable
</span><span>
</span><span>For more information about this error, try `rustc --explain E0658`.
</span><span>error: could not compile `playground` due to 3 previous errors
</span></code></pre>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=bf901cbff2766011157dfb4066be00a1">Rust Playgroundで確認</a></p>
<p>これは<code>const fn</code>の中で浮動小数点演算が行えないというエラーなので<code>#![feature(const_fn_floating_point_arithmetic)]</code>を書くことで解決できます。</p>
<p>変更後のコードは差分が少ないので載せませんが<a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=2b6bd9cb82fc038e2bfadf76c234053d">Rust Playgroundで確認</a>できるので気になる方はリンク先を確認してみてください。</p>
<h2 id="addassign">AddAssign</h2>
<p>次に<code>AddAssign</code>を定義します。</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">impl </span><span>const AddAssign&lt;Vec3&gt; for Vec3 {
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">add_assign</span><span>(&amp;</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">rhs</span><span>: Vec3) {
</span><span>        *</span><span style="color:#bf616a;">self </span><span>= Vec3 {
</span><span>            x: </span><span style="color:#bf616a;">self</span><span>.x + rhs.x,
</span><span>            y: </span><span style="color:#bf616a;">self</span><span>.y + rhs.y,
</span><span>            z: </span><span style="color:#bf616a;">self</span><span>.z + rhs.z,
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#b48ead;">const fn </span><span style="color:#8fa1b3;">const_function</span><span>() {
</span><span>  </span><span style="color:#b48ead;">let mut</span><span> v1: Vec3 = Vec3 { x: </span><span style="color:#d08770;">1.0</span><span>, y: </span><span style="color:#d08770;">2.0</span><span>, z: </span><span style="color:#d08770;">3.0 </span><span>};
</span><span>  </span><span style="color:#b48ead;">let</span><span> v2: Vec3 = Vec3 { x: </span><span style="color:#d08770;">2.0</span><span>, y: </span><span style="color:#d08770;">3.0</span><span>, z: </span><span style="color:#d08770;">4.0 </span><span>};
</span><span>  
</span><span>  v1 += v2;
</span><span>}
</span></code></pre>
<p>上記のように<code>Add</code>と同じように<code>impl const AddAssign</code>で定義して<code>const fn</code>で使用してみると</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>   Compiling playground v0.0.1 (/playground)
</span><span>error[E0658]: mutable references are not allowed in constant functions
</span><span>  --&gt; src/lib.rs:25:19
</span><span>   |
</span><span>25 |     fn add_assign(&amp;mut self, rhs: Vec3) {
</span><span>   |                   ^^^^^^^^^
</span><span>   |
</span><span>   = note: see issue #57349 &lt;https://github.com/rust-lang/rust/issues/57349&gt; for more information
</span><span>   = help: add `#![feature(const_mut_refs)]` to the crate attributes to enable
</span><span>
</span><span>error[E0658]: mutable references are not allowed in constant functions
</span><span>  --&gt; src/lib.rs:38:3
</span><span>   |
</span><span>38 |   v1 += v2;
</span><span>   |   ^^
</span><span>   |
</span><span>   = note: see issue #57349 &lt;https://github.com/rust-lang/rust/issues/57349&gt; for more information
</span><span>   = help: add `#![feature(const_mut_refs)]` to the crate attributes to enable
</span><span>
</span><span>For more information about this error, try `rustc --explain E0658`.
</span><span>error: could not compile `playground` due to 2 previous errors
</span></code></pre>
<p>というエラーが出ます。<br />
<a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=c1c31669ade86dc2bbf93eb66475b3dc">Rust Playgroundで確認</a></p>
<p>これは<code>&amp;mut</code>な変数を引数にする関数が<code>const fn</code>の中で使えないという内容で<code>#![feature(const_mut_refs)]</code>を追加してやることで解決できます。</p>
<details>
<summary>コード全文</summary>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#![</span><span style="color:#bf616a;">feature</span><span>(const_trait_impl)]
</span><span>#![</span><span style="color:#bf616a;">feature</span><span>(const_fn_floating_point_arithmetic)]
</span><span>#![</span><span style="color:#bf616a;">feature</span><span>(const_mut_refs)]
</span><span>
</span><span style="color:#b48ead;">use </span><span>std::ops::*;
</span><span>
</span><span style="color:#b48ead;">struct </span><span>Vec3 {
</span><span>    </span><span style="color:#bf616a;">x</span><span>: </span><span style="color:#b48ead;">f64</span><span>,
</span><span>    </span><span style="color:#bf616a;">y</span><span>: </span><span style="color:#b48ead;">f64</span><span>,
</span><span>    </span><span style="color:#bf616a;">z</span><span>: </span><span style="color:#b48ead;">f64</span><span>,
</span><span>}
</span><span>
</span><span style="color:#b48ead;">impl </span><span>const Add&lt;Vec3&gt; for Vec3 {
</span><span>    </span><span style="color:#b48ead;">type </span><span>Output = </span><span style="color:#b48ead;">Self</span><span>;
</span><span>
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">add</span><span>(</span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">rhs</span><span>: Vec3) -&gt; </span><span style="color:#b48ead;">Self::</span><span>Output {
</span><span>        Vec3 {
</span><span>            x: </span><span style="color:#bf616a;">self</span><span>.x + rhs.x,
</span><span>            y: </span><span style="color:#bf616a;">self</span><span>.y + rhs.y,
</span><span>            z: </span><span style="color:#bf616a;">self</span><span>.z + rhs.z,
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#b48ead;">impl </span><span>const AddAssign&lt;Vec3&gt; for Vec3 {
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">add_assign</span><span>(&amp;</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">rhs</span><span>: Vec3) {
</span><span>        *</span><span style="color:#bf616a;">self </span><span>= Vec3 {
</span><span>            x: </span><span style="color:#bf616a;">self</span><span>.x + rhs.x,
</span><span>            y: </span><span style="color:#bf616a;">self</span><span>.y + rhs.y,
</span><span>            z: </span><span style="color:#bf616a;">self</span><span>.z + rhs.z,
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#b48ead;">const fn </span><span style="color:#8fa1b3;">const_function</span><span>() {
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> v1: Vec3 = Vec3 { x: </span><span style="color:#d08770;">1.0</span><span>, y: </span><span style="color:#d08770;">2.0</span><span>, z: </span><span style="color:#d08770;">3.0 </span><span>};
</span><span>    </span><span style="color:#b48ead;">let</span><span> v2: Vec3 = Vec3 { x: </span><span style="color:#d08770;">2.0</span><span>, y: </span><span style="color:#d08770;">3.0</span><span>, z: </span><span style="color:#d08770;">4.0 </span><span>};
</span><span>    
</span><span>    v1 += v2;
</span><span>}
</span></code></pre>
</details>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=227a07ebe8a5143859a0087606415855">Rust Playgroundで確認</a></p>
<h2 id="indexmut">IndexMut</h2>
<p>続いて<code>IndexMut</code>を定義します。<br />
<code>IndexMut</code>の定義は<code>Index</code>の定義が必要なので両方定義します。</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">impl </span><span>const Index&lt;</span><span style="color:#b48ead;">usize</span><span>&gt; for Vec3 {
</span><span>    </span><span style="color:#b48ead;">type </span><span>Output = </span><span style="color:#b48ead;">f64</span><span>;
</span><span>    
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">index</span><span>(&amp;</span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">i</span><span>: </span><span style="color:#b48ead;">usize</span><span>) -&gt; &amp;</span><span style="color:#b48ead;">Self::</span><span>Output {
</span><span>        </span><span style="color:#b48ead;">match</span><span> i {
</span><span>            </span><span style="color:#d08770;">0 </span><span>=&gt; &amp;</span><span style="color:#bf616a;">self</span><span>.x,
</span><span>            </span><span style="color:#d08770;">1 </span><span>=&gt; &amp;</span><span style="color:#bf616a;">self</span><span>.y,
</span><span>            </span><span style="color:#d08770;">2 </span><span>=&gt; &amp;</span><span style="color:#bf616a;">self</span><span>.z,
</span><span>            _ =&gt; panic!(&quot;</span><span style="color:#a3be8c;">out of range.</span><span>&quot;),
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#b48ead;">impl </span><span>const IndexMut&lt;</span><span style="color:#b48ead;">usize</span><span>&gt; for Vec3 {
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">index_mut</span><span>(&amp;</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">i</span><span>: </span><span style="color:#b48ead;">usize</span><span>) -&gt; &amp;</span><span style="color:#b48ead;">mut Self::</span><span>Output {
</span><span>        </span><span style="color:#b48ead;">match</span><span> i {
</span><span>            </span><span style="color:#d08770;">0 </span><span>=&gt; &amp;</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">self</span><span>.x,
</span><span>            </span><span style="color:#d08770;">1 </span><span>=&gt; &amp;</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">self</span><span>.y,
</span><span>            </span><span style="color:#d08770;">2 </span><span>=&gt; &amp;</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">self</span><span>.z,
</span><span>            _ =&gt; panic!(&quot;</span><span style="color:#a3be8c;">out of range.</span><span>&quot;),
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre>
<p>ここまでに
<code>#![feature(const_trait_impl)]</code>, <code>#![feature(const_fn_floating_point_arithmetic)]</code>, <code>#![feature(const_mut_refs)]</code>を有効にしているため、特別なことをする必要はありません。<br />
<code>index</code>と<code>index_mut</code>の中で<code>panic!</code>を使用していますが、これは何もせずとも<code>const fn</code>の中で使用できます。</p>
<p>これで</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">const fn </span><span style="color:#8fa1b3;">const_function</span><span>() {
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> v: Vec3 = Vec3 { x: </span><span style="color:#d08770;">1.0</span><span>, y: </span><span style="color:#d08770;">2.0</span><span>, z: </span><span style="color:#d08770;">3.0 </span><span>};
</span><span>    v[</span><span style="color:#d08770;">0</span><span>] = </span><span style="color:#d08770;">0.0</span><span>;
</span><span>}
</span></code></pre>
<p>という処理のコンパイルが通るようになりました。</p>
<details>
<summary>コード全文</summary>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#![</span><span style="color:#bf616a;">feature</span><span>(const_trait_impl)]
</span><span>#![</span><span style="color:#bf616a;">feature</span><span>(const_fn_floating_point_arithmetic)]
</span><span>#![</span><span style="color:#bf616a;">feature</span><span>(const_mut_refs)]
</span><span>
</span><span style="color:#b48ead;">use </span><span>std::ops::*;
</span><span>
</span><span style="color:#b48ead;">struct </span><span>Vec3 {
</span><span>    </span><span style="color:#bf616a;">x</span><span>: </span><span style="color:#b48ead;">f64</span><span>,
</span><span>    </span><span style="color:#bf616a;">y</span><span>: </span><span style="color:#b48ead;">f64</span><span>,
</span><span>    </span><span style="color:#bf616a;">z</span><span>: </span><span style="color:#b48ead;">f64</span><span>,
</span><span>}
</span><span>
</span><span style="color:#b48ead;">impl </span><span>const Add&lt;Vec3&gt; for Vec3 {
</span><span>    </span><span style="color:#b48ead;">type </span><span>Output = </span><span style="color:#b48ead;">Self</span><span>;
</span><span>
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">add</span><span>(</span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">rhs</span><span>: Vec3) -&gt; </span><span style="color:#b48ead;">Self::</span><span>Output {
</span><span>        Vec3 {
</span><span>            x: </span><span style="color:#bf616a;">self</span><span>.x + rhs.x,
</span><span>            y: </span><span style="color:#bf616a;">self</span><span>.y + rhs.y,
</span><span>            z: </span><span style="color:#bf616a;">self</span><span>.z + rhs.z,
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#b48ead;">impl </span><span>const AddAssign&lt;Vec3&gt; for Vec3 {
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">add_assign</span><span>(&amp;</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">rhs</span><span>: Vec3) {
</span><span>        *</span><span style="color:#bf616a;">self </span><span>= Vec3 {
</span><span>            x: </span><span style="color:#bf616a;">self</span><span>.x + rhs.x,
</span><span>            y: </span><span style="color:#bf616a;">self</span><span>.y + rhs.y,
</span><span>            z: </span><span style="color:#bf616a;">self</span><span>.z + rhs.z,
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#b48ead;">impl </span><span>const Index&lt;</span><span style="color:#b48ead;">usize</span><span>&gt; for Vec3 {
</span><span>    </span><span style="color:#b48ead;">type </span><span>Output = </span><span style="color:#b48ead;">f64</span><span>;
</span><span>
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">index</span><span>(&amp;</span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">i</span><span>: </span><span style="color:#b48ead;">usize</span><span>) -&gt; &amp;</span><span style="color:#b48ead;">Self::</span><span>Output {
</span><span>        </span><span style="color:#b48ead;">match</span><span> i {
</span><span>            </span><span style="color:#d08770;">0 </span><span>=&gt; &amp;</span><span style="color:#bf616a;">self</span><span>.x,
</span><span>            </span><span style="color:#d08770;">1 </span><span>=&gt; &amp;</span><span style="color:#bf616a;">self</span><span>.y,
</span><span>            </span><span style="color:#d08770;">2 </span><span>=&gt; &amp;</span><span style="color:#bf616a;">self</span><span>.z,
</span><span>            _ =&gt; panic!(&quot;</span><span style="color:#a3be8c;">out of range.</span><span>&quot;),
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#b48ead;">impl </span><span>const IndexMut&lt;</span><span style="color:#b48ead;">usize</span><span>&gt; for Vec3 {
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">index_mut</span><span>(&amp;</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">i</span><span>: </span><span style="color:#b48ead;">usize</span><span>) -&gt; &amp;</span><span style="color:#b48ead;">mut Self::</span><span>Output {
</span><span>        </span><span style="color:#b48ead;">match</span><span> i {
</span><span>            </span><span style="color:#d08770;">0 </span><span>=&gt; &amp;</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">self</span><span>.x,
</span><span>            </span><span style="color:#d08770;">1 </span><span>=&gt; &amp;</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">self</span><span>.y,
</span><span>            </span><span style="color:#d08770;">2 </span><span>=&gt; &amp;</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">self</span><span>.z,
</span><span>            _ =&gt; panic!(&quot;</span><span style="color:#a3be8c;">out of range.</span><span>&quot;),
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#b48ead;">const fn </span><span style="color:#8fa1b3;">const_function</span><span>() {
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> v: Vec3 = Vec3 { x: </span><span style="color:#d08770;">1.0</span><span>, y: </span><span style="color:#d08770;">2.0</span><span>, z: </span><span style="color:#d08770;">3.0 </span><span>};
</span><span>    v[</span><span style="color:#d08770;">0</span><span>] = </span><span style="color:#d08770;">0.0</span><span>;
</span><span>}
</span></code></pre>
</details>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=0765cedc3493bc26e70bb195653b6670">Rust Playgroundで確認</a><br />
コンパイルに時間がかかることがありRust Playgroundではタイムアウトするかもしれません。</p>
<h3 id="panic-nei-denobian-shu-mai-meip-mihadekinai">panic!内での変数埋め込みはできない</h3>
<p><code>panic!</code>が使えるなら<code>panic!(&quot;out of range. index = {i}&quot;)</code>のようにどの値が渡されたことで範囲外アクセスが発生したのかをコンパイルエラーのメッセージに表示したくなると思います。<br />
しかし普通に書いても下記のようなコンパイルエラーが発生してしまいます。</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>   Compiling playground v0.0.1 (/playground)
</span><span>error[E0658]: function pointer casts are not allowed in constant functions
</span><span>  --&gt; src/lib.rs:43:48
</span><span>   |
</span><span>43 |             _ =&gt; panic!(&quot;out of range. index = {i}&quot;),
</span><span>   |                                                ^^^
</span><span>   |
</span><span>   = note: see issue #57563 &lt;https://github.com/rust-lang/rust/issues/57563&gt; for more information
</span><span>   = help: add `#![feature(const_fn_fn_ptr_basics)]` to the crate attributes to enable
</span><span>   = note: this error originates in the macro `$crate::const_format_args` (in Nightly builds, run with -Z macro-backtrace for more info)
</span><span>
</span><span>error[E0015]: calls in constant functions are limited to constant functions, tuple structs and tuple variants
</span><span>  --&gt; src/lib.rs:43:18
</span><span>   |
</span><span>43 |             _ =&gt; panic!(&quot;out of range. index = {i}&quot;),
</span><span>   |                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
</span><span>   |
</span><span>   = note: this error originates in the macro `$crate::const_format_args` (in Nightly builds, run with -Z macro-backtrace for more info)
</span><span>
</span><span>Some errors have detailed explanations: E0015, E0658.
</span><span>For more information about an error, try `rustc --explain E0015`.
</span><span>error: could not compile `playground` due to 2 previous errors
</span></code></pre>
<p>これはコンパイルエラーにあるように<code>#![feature(const_fn_fn_ptr_basics)]</code>を追記してもコンパイルは通りません。<br />
ビルド時の引数次第でなんとかなりそうなエラーは出ていましたがそこまで確認はしていないです。</p>
<h2 id="matome">まとめ</h2>
<p><code>#![feature(const_trait_impl)]</code>, <code>#![feature(const_fn_floating_point_arithmetic)]</code>, <code>#![feature(const_mut_refs)]</code>を追加しTraitの実装時に<code>impl const</code>と書いてやれば普通に定義するのと変わらないように書くことができます。</p>
</p>
<hr>
<p class="share_buttons">
  <a class="twitter-share-button" data-text="const fnで使用可能なVec3を定義する - blockの巣" href="https://twitter.com/intent/tweet">Tweet</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</p>

    </div>
  </section>
  <footer>
    
    
    copyright 2019 block.
    
    
  </footer>

  
  <script>
    const ga_tracking_id = "UA-148823095-1";
    const ga_accept_message = `当サイトではアクセス解析ツールGoogle Analyticsを使用しています。Google Analyticsはトラフィックデータの収集のためにCookieを使用します。
データ収集の同意の状態はPrivacy Policyからいつでもリセットできます。
サイトの閲覧数などを確認したいので同意していただけると嬉しいです。`;
    const privacy_policy_url = "https://block-cube-lib.github.io/privacy-policy/";
  </script>
  <script src="https://block-cube-lib.github.io/js/ga-cookie-accept.js"></script>
  
</body>

</html>
